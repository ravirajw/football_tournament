<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Tournament Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .team-setup {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .team-card {
            padding: 15px;
            border-radius: 10px;
            color: white;
        }

        .team-red { background: linear-gradient(135deg, #d32f2f, #c62828); }
        .team-black { background: linear-gradient(135deg, #424242, #212121); }
        .team-white { background: linear-gradient(135deg, #bdbdbd, #9e9e9e); color: #333; }

        .team-card h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .player-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .player-list {
            margin-top: 10px;
        }

        .player-item {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-white .player-item {
            background: rgba(0,0,0,0.1);
        }

        .matches-grid {
            display: grid;
            gap: 15px;
        }

        .match-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .match-teams {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 20px 0;
            font-size: 1.5em;
            font-weight: bold;
        }

        .score {
            font-size: 2em;
            color: #667eea;
        }

        .match-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .goal-section {
            margin-top: 15px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .points-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .points-table th,
        .points-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .points-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .points-table tr:hover {
            background: #f5f5f5;
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 10px 0;
        }

        .goal-log {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .goal-item {
            padding: 5px;
            margin: 3px 0;
            background: #e8f5e9;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .save-item {
            background: #e3f2fd;
        }

        .own-goal {
            background: #ffebee;
        }

        .hidden {
            display: none;
        }

        .final-match {
            border: 3px solid gold;
            background: linear-gradient(135deg, #fff9c4, #fff59d);
        }

        .winner-announcement {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-radius: 15px;
            margin: 20px 0;
        }

        .winner-announcement h2 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .remove-btn {
            background: rgba(220, 53, 69, 0.8);
            color: white;
            padding: 4px 8px;
            font-size: 12px;
        }

        .tiebreaker-modal {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .tiebreaker-modal h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .team-option {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
            font-weight: bold;
        }

        .team-option:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .whatsapp-message-box {
            background: #e7f3e7;
            border: 2px solid #25D366;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .whatsapp-message-box h3 {
            color: #075E54;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            text-align: left;
        }

        .copy-btn {
            background: #25D366;
            color: white;
            padding: 12px 24px;
            margin-top: 10px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #128C7E;
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }

        .keeper-selection {
            margin: 15px 0;
        }

        .keeper-selection h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .keeper-info {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚽ Football Tournament Manager</h1>
        
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .page {
                display: none;
            }
            
            .page.active {
                display: block;
            }
        </style>
        
        <!-- Loader Page -->
        <div id="loaderPage" class="page active">
            <div style="text-align: center; padding: 80px 20px;">
                <div style="width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid #667eea; border-radius: 50%; margin: 0 auto 30px; animation: spin 1s linear infinite;"></div>
                <h2 style="color: #667eea; margin-bottom: 15px;">Loading Tournament...</h2>
                <p style="color: #666;">Please wait while we fetch the tournament data</p>
            </div>
            <div style="margin-top: 30px; padding: 20px; display: flex; justify-content: space-between; align-items: center; color: #999; font-size: 0.75em; border-top: 1px solid #eee;">
                <span>v1.5.7</span>
                <span>UTC: <span class="deviceUTC">--</span></span>
            </div>
        </div>
        
        <!-- Tournament Not Found Page -->
        <div id="notFoundPage" class="page">
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 80px; margin-bottom: 20px;">⚠️</div>
                <h2 style="color: #d32f2f; margin-bottom: 15px;">Tournament Not Found</h2>
                <p style="color: #666; font-size: 1.1em; margin-bottom: 10px;">
                    The tournament you're looking for doesn't exist or has been deleted.
                </p>
                <p id="notFoundTournamentId" style="color: #999; font-size: 0.9em; margin-bottom: 30px;">
                </p>
                <button onclick="goToHome()" class="btn-primary" style="padding: 12px 30px; font-size: 1.1em;">
                    🏠 Go to Home
                </button>
            </div>
            <div style="margin-top: 30px; padding: 20px; display: flex; justify-content: space-between; align-items: center; color: #999; font-size: 0.75em; border-top: 1px solid #eee;">
                <span>v1.5.7</span>
                <span>UTC: <span class="deviceUTC">--</span></span>
            </div>
        </div>
        
        <!-- Create Tournament Page (Team Setup) -->
        <div id="createTournamentPage" class="page">
            <div class="section">
            <h2>Team Setup</h2>
            <div class="team-setup">
                <div class="team-card team-red">
                    <h3>Red Team</h3>
                    <div class="player-input">
                        <input type="text" id="redPlayerInput" placeholder="Enter player name">
                        <button class="btn-primary" onclick="addPlayer('red')">Add</button>
                    </div>
                    <div class="player-list" id="redPlayers"></div>
                </div>

                <div class="team-card team-black">
                    <h3>Black Team</h3>
                    <div class="player-input">
                        <input type="text" id="blackPlayerInput" placeholder="Enter player name">
                        <button class="btn-primary" onclick="addPlayer('black')">Add</button>
                    </div>
                    <div class="player-list" id="blackPlayers"></div>
                </div>

                <div class="team-card team-white">
                    <h3>White Team</h3>
                    <div class="player-input">
                        <input type="text" id="whitePlayerInput" placeholder="Enter player name">
                        <button class="btn-primary" onclick="addPlayer('white')">Add</button>
                    </div>
                    <div class="player-list" id="whitePlayers"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-primary" style="padding: 10px 30px; font-size: 16px; margin-right: 10px;" onclick="addTestPlayers()">Add Test Players</button>
                <button class="btn-success" style="padding: 15px 40px; font-size: 18px;" onclick="startTournament()">Start Tournament</button>
            </div>
        </div>
        <div style="margin-top: 30px; padding: 20px; display: flex; justify-content: space-between; align-items: center; color: #999; font-size: 0.75em; border-top: 1px solid #eee;">
            <span>v1.5.7</span>
            <span>UTC: <span class="deviceUTC">--</span></span>
        </div>
        </div>
        
        <!-- Tournament Detail Page -->
        <div id="tournamentDetailPage" class="page">
            <!-- Header with Date and Admin Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="font-size: 1.1em; color: #666;">
                    📅 <strong id="dateText"></strong>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="adminControls" style="display: none;">
                        <button class="btn-primary" onclick="showAdminLogin()" style="padding: 8px 16px;">
                            🔐 Admin Login
                        </button>
                    </div>
                    <div id="adminStatus" style="display: none; color: #28a745; font-weight: bold;">
                        ✅ Admin Mode
                        <button onclick="logoutAdmin()" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
                    </div>
                </div>
            </div>
            
            <!-- WATCH LIVE Section (dynamically populated, visible to all) -->
            <div id="watchLiveMessageContainer"></div>
            
            <!-- WhatsApp Message Section (admin only) -->
            <div class="whatsapp-message-box hidden" id="whatsappMessageBox">
                <h3>
                    <span style="font-size: 1.5em;">📱</span>
                    WhatsApp Message - Share Tournament Info
                </h3>
                <div class="message-content" id="messageContent"></div>
                <button id="copyMessageBtn" class="copy-btn" onclick="copyWhatsAppMessage()">
                    📋 Copy Message
                </button>
            </div>
            
            <!-- Matches Section -->
            <div class="section" id="matchesSection">
            <h2>Matches</h2>

            <div class="matches-grid" id="matchesGrid"></div>
        </div>

        <!-- Points Table Section -->
        <div class="section" id="tableSection">
            <h2>Points Table</h2>
            <table class="points-table">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Team</th>
                        <th>P</th>
                        <th>W</th>
                        <th>D</th>
                        <th>L</th>
                        <th>GF</th>
                        <th>GA</th>
                        <th>GD</th>
                        <th>CS</th>
                        <th>Pts</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                <strong>* Tiebreaker Order:</strong> 1. Points, 2. Goal Difference (GD), 3. Head-to-Head (H2H), 4. Goals Scored (GF), 5. Clean Sheets (CS)
            </div>
            <div id="qualificationNote" style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 5px; font-size: 0.9em; display: none;">
                <strong style="color: #1976D2;">📋 Final Qualification:</strong>
                <div id="qualificationDetails" style="margin-top: 8px; color: #555;"></div>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div class="section" id="leaderboardSection">
            <h2>Leaderboard</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #ffc107;">
                    <h3 style="color: #ffc107; margin-bottom: 10px;">⚽ Top Scorers</h3>
                    <div id="topScorers" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">🎯 Top Assists</h3>
                    <div id="topAssists" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #dc3545;">
                    <h3 style="color: #dc3545; margin-bottom: 10px;">😬 Own Goals</h3>
                    <div id="ownGoals" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #28a745;">
                    <h3 style="color: #28a745; margin-bottom: 10px;">🧤 Keeper Saves</h3>
                    <div id="topKeeper" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #17a2b8;">
                    <h3 style="color: #17a2b8; margin-bottom: 10px;">🛡️ Clean Sheets (Teams)</h3>
                    <div id="mostCleanSheets" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #d32f2f;">
                    <h3 style="color: #d32f2f; margin-bottom: 10px;">🔥 Goals Scored (Teams)</h3>
                    <div id="mostGoals" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #ff6b6b;">
                    <h3 style="color: #ff6b6b; margin-bottom: 10px;">⚠️ Goals Conceded (Teams)</h3>
                    <div id="mostConceded" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #6f42c1;">
                    <h3 style="color: #6f42c1; margin-bottom: 10px;">📊 Goal Difference (Teams)</h3>
                    <div id="bestGD" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
        
        <!-- Winner Section (dynamically populated) -->
        <div id="winnerSection"></div>

        <!-- Tournament Summary Section -->
        <div class="section" id="tournamentSummarySection" style="display: none;">
            <h2>Tournament Summary</h2>
            <div class="whatsapp-message-box">
                <h3>
                    <span style="font-size: 1.5em;">📱</span>
                    WhatsApp Summary - Share Tournament Results
                </h3>
                <div class="message-content" id="summaryMessageContent"></div>
                <button class="copy-btn" onclick="copySummaryMessage()">
                    📋 Copy Summary
                </button>
            </div>
        </div>
        
        <!-- Delete Tournament Button (admin only) -->
        <div id="deleteTournamentSection" class="section" style="display: none; text-align: center; margin-top: 30px;">
            <button id="deleteTournamentBtn" class="btn-danger" style="padding: 12px 30px; font-size: 16px;">
                🗑️ Delete Tournament
            </button>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; display: flex; justify-content: space-between; align-items: center; color: #999; font-size: 0.75em; border-top: 1px solid #eee;">
            <span>v1.5.7</span>
            <span>UTC: <span class="deviceUTC">--</span></span>
        </div>
        </div>
    </div>

    <div class="modal" id="adminPasswordModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: #667eea;">🔐 Set Admin Password</h2>
            <p style="margin-bottom: 15px; color: #666;">
                Create a password to manage this tournament. You'll need this password to start matches, record events, and make changes.
            </p>
            <input type="password" id="adminPasswordInput" placeholder="Enter admin password" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #667eea; border-radius: 5px; font-size: 16px;">
            <input type="password" id="adminPasswordConfirm" placeholder="Confirm admin password" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #667eea; border-radius: 5px; font-size: 16px;">
            <button class="btn-success" style="width: 100%;" onclick="setAdminPassword()">Start Tournament</button>
        </div>
    </div>

    <div class="modal" id="adminLoginModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: #667eea;">🔐 Admin Login</h2>
            <p style="margin-bottom: 15px; color: #666;">
                Enter the admin password to manage this tournament.
            </p>
            <input type="password" id="adminLoginInput" placeholder="Enter admin password" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #667eea; border-radius: 5px; font-size: 16px;">
            <div style="display: flex; gap: 10px;">
                <button class="btn-danger" style="flex: 1;" onclick="closeAdminLogin()">Cancel</button>
                <button class="btn-success" style="flex: 1;" onclick="verifyAdminLogin()">Login</button>
            </div>
        </div>
    </div>

    <div class="modal" id="keeperModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: #667eea;">Select Goalkeepers</h2>
            <div id="keeperSelectionContent"></div>
            <button class="btn-success" style="width: 100%; margin-top: 20px;" onclick="confirmKeepers()">Start Match</button>
        </div>
    </div>

    <div class="modal" id="eventModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: #667eea;" id="eventModalTitle">Record Event</h2>
            <div id="eventModalContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-danger" style="flex: 1;" onclick="closeEventModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration (update with your credentials) -->
    <script src="js/firebase-config.js"></script>
    
    <!-- Firebase Storage Manager -->
    <script src="js/firebase-storage.js"></script>

    <script>
        let teams = {
            red: { name: 'Red', players: [], color: '#d32f2f' },
            black: { name: 'Black', players: [], color: '#424242' },
            white: { name: 'White', players: [], color: '#9e9e9e' }
        };

        let standings = {
            red: { played: 0, won: 0, drawn: 0, lost: 0, gf: 0, ga: 0, points: 0 },
            black: { played: 0, won: 0, drawn: 0, lost: 0, gf: 0, ga: 0, points: 0 },
            white: { played: 0, won: 0, drawn: 0, lost: 0, gf: 0, ga: 0, points: 0 }
        };

        let matches = [];
        let currentRound = 1;
        let currentMatchForKeeper = null;
        let currentEventMatch = null;
        let currentEventType = null;
        let eventStep = 0;
        let eventData = {};
        let playerStats = {};
        let keeperStats = {};
        let tiebreakerTeams = null;
        let tournamentDate = null;
        let adminPassword = null;
        let isAdmin = false;
        let currentTournamentId = null;
        let allTournaments = {};
        
        // Global timer tracking
        let matchTimers = {}; // { matchId: { startTime: timestamp, interval: intervalId } }
        
        // Flag to track if page has been reorganized for completed tournament
        let pageReorganized = false;
        
        // Firebase integration
        let firebaseStorage = null;
        let useFirebase = false;
        
        // Initialize Firebase Storage Manager
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined' && typeof FirebaseStorageManager !== 'undefined') {
                    firebaseStorage = new FirebaseStorageManager();
                    if (firebaseStorage.initialize()) {
                        useFirebase = true;
                        console.log('✅ Using Firebase for storage');
                        return true;
                    }
                }
            } catch(e) {
                console.warn('⚠️ Firebase not available, falling back to localStorage:', e);
            }
            
            useFirebase = false;
            console.log('📦 Using localStorage for storage');
            return false;
        }

        // Tournament management functions
        function generateTournamentId() {
            return 'tournament_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function loadTournamentsFromStorage() {
            if (useFirebase && firebaseStorage) {
                console.log('Loading tournaments from Firebase...');
                try {
                    allTournaments = await firebaseStorage.loadTournaments();
                    console.log('Loaded from Firebase:', allTournaments);
                } catch(e) {
                    console.error('Error loading from Firebase:', e);
                    allTournaments = {};
                }
            } else {
                console.log('Loading tournaments from localStorage...');
                const stored = localStorage.getItem('footballTournaments');
                console.log('Raw localStorage data:', stored);
                
                if (stored) {
                    try {
                        allTournaments = JSON.parse(stored);
                        console.log('Successfully parsed tournaments:', allTournaments);
                    } catch(e) {
                        console.error('Error parsing tournaments from localStorage:', e);
                        allTournaments = {};
                    }
                } else {
                    console.log('No tournaments found in localStorage');
                    allTournaments = {};
                }
            }
        }

        async function saveTournamentToStorage() {
            if (useFirebase && firebaseStorage && currentTournamentId) {
                try {
                    await firebaseStorage.saveTournament(currentTournamentId, allTournaments[currentTournamentId]);
                    console.log('✅ Saved to Firebase');
                } catch(e) {
                    console.error('Error saving to Firebase:', e);
                }
            } else {
                localStorage.setItem('footballTournaments', JSON.stringify(allTournaments));
                console.log('✅ Saved to localStorage');
            }
        }

        function getTournamentShareLink(tournamentId) {
            return window.location.href.split('?')[0] + '?tournament=' + tournamentId;
        }

        // Page navigation functions
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show requested page
            const page = document.getElementById(pageName);
            if (page) {
                page.classList.add('active');
            }
        }
        
        function goToHome() {
            // Clear URL parameters
            window.history.pushState({}, '', window.location.pathname);
            showPage('createTournamentPage');
        }
        
        async function loadTournamentFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const tournamentId = urlParams.get('tournament');
            
            if (tournamentId) {
                console.log('Checking tournament ID:', tournamentId);
                
                // If using Firebase, try to load directly from Firestore
                if (useFirebase && firebaseStorage) {
                    try {
                        const tournamentData = await firebaseStorage.getTournament(tournamentId);
                        if (tournamentData) {
                            allTournaments[tournamentId] = tournamentData;
                            console.log('✅ Loaded tournament from Firebase:', tournamentId);
                            loadTournament(tournamentId);
                            
                            // Set up real-time listener for Firebase
                            setupFirebaseListener(tournamentId);
                            showPage('tournamentDetailPage');
                            return true;
                        }
                    } catch(e) {
                        console.error('Error loading from Firebase:', e);
                    }
                }
                
                // Fallback to checking loaded tournaments
                console.log('Available tournaments:', Object.keys(allTournaments));
                
                if (allTournaments[tournamentId]) {
                    console.log('✅ Loading tournament:', tournamentId);
                    loadTournament(tournamentId);
                    
                    // Set up real-time listener for Firebase
                    if (useFirebase && firebaseStorage) {
                        setupFirebaseListener(tournamentId);
                    }
                    showPage('tournamentDetailPage');
                    return true;
                } else {
                    console.error('❌ Tournament not found in storage!');
                    console.error('Requested ID:', tournamentId);
                    console.error('Available IDs:', Object.keys(allTournaments));
                    
                    // Show not found page
                    document.getElementById('notFoundTournamentId').innerHTML = 
                        `Tournament ID: <code style="background: #f5f5f5; padding: 2px 8px; border-radius: 3px;">${tournamentId}</code>`;
                    showPage('notFoundPage');
                    return false;
                }
            }
            return false;
        }
        
        // Setup Firebase real-time listener
        function setupFirebaseListener(tournamentId) {
            if (!useFirebase || !firebaseStorage) return;
            
            console.log('🔥 Setting up Firebase real-time listener...');
            firebaseStorage.listenToTournament(tournamentId, (updatedData) => {
                if (updatedData && currentTournamentId === tournamentId) {
                    console.log('🔥 Tournament updated from Firebase!');
                    
                    // Update local data
                    allTournaments[tournamentId] = updatedData;
                    
                    // Reload tournament UI
                    teams = updatedData.teams;
                    matches = updatedData.matches;
                    standings = updatedData.standings;
                    playerStats = updatedData.playerStats || {};
                    keeperStats = updatedData.keeperStats || {};
                    
                    // Restart timers for any live matches that don't have them
                    restartLiveMatchTimers();
                    
                    // Re-render UI
                    renderMatches();
                    updateTable();
                    updateLeaderboard();
                }
            });
        }

        function loadTournament(tournamentId) {
            const tournament = allTournaments[tournamentId];
            if (!tournament) {
                console.error('Tournament not found in allTournaments:', tournamentId);
                return;
            }

            console.log('Loading tournament data:', tournament);
            
            currentTournamentId = tournamentId;
            teams = tournament.teams;
            matches = tournament.matches;
            standings = tournament.standings;
            tournamentDate = tournament.date;
            adminPassword = tournament.adminPassword;
            playerStats = tournament.playerStats || {};
            keeperStats = tournament.keeperStats || {};

            // Check if admin session exists for this tournament
            const isAdminSession = sessionStorage.getItem(`admin_${tournamentId}`) === 'true';
            if (isAdminSession) {
                isAdmin = true;
                console.log('Admin session restored');
            } else {
                isAdmin = false;
            }

            console.log('Tournament data loaded into variables');
            console.log('Teams:', teams);
            console.log('Matches:', matches.length);

            // Update UI - tournament sections are already visible in the page
            console.log('Updating tournament UI...');
            document.getElementById('dateText').textContent = tournamentDate;
            
            // Show admin status or login button based on session
            if (isAdmin) {
                document.getElementById('adminControls').style.display = 'none';
                document.getElementById('adminStatus').style.display = 'block';
                // Show admin-only sections
                document.getElementById('whatsappMessageBox').classList.remove('hidden');
                const deleteSection = document.getElementById('deleteTournamentSection');
                if (deleteSection) {
                    deleteSection.style.display = 'block';
                    // Set up delete button with correct tournament ID
                    const deleteBtn = document.getElementById('deleteTournamentBtn');
                    if (deleteBtn) {
                        deleteBtn.onclick = () => deleteTournament(currentTournamentId);
                    }
                }
            } else {
                document.getElementById('adminControls').style.display = 'block';
                document.getElementById('adminStatus').style.display = 'none';
                // Hide admin-only sections
                document.getElementById('whatsappMessageBox').classList.add('hidden');
                const deleteSection = document.getElementById('deleteTournamentSection');
                if (deleteSection) {
                    deleteSection.style.display = 'none';
                }
            }
            
            console.log('Showing WATCH LIVE message...');
            // Show WATCH LIVE message
            showWatchLiveMessage();
            
            // Generate WhatsApp message for admins
            generateWhatsAppMessage();
            
            console.log('Rendering tournament data...');
            // Render all the tournament data
            renderMatches();
            updateTable();
            updateLeaderboard();
            
            // Also render the team players in case we need to see them
            renderPlayers('red');
            renderPlayers('black');
            renderPlayers('white');
            
            // Restart intervals for live matches
            restartLiveMatchTimers();
            
            console.log('Tournament loaded successfully!');
        }

        async function deleteTournament(tournamentId) {
            if (confirm('Are you sure you want to delete this tournament? This action cannot be undone.')) {
                delete allTournaments[tournamentId];
                
                // Delete from Firebase if using Firebase
                if (useFirebase && firebaseStorage) {
                    try {
                        await firebaseStorage.deleteTournament(tournamentId);
                        console.log('✅ Deleted from Firebase');
                    } catch(e) {
                        console.error('Error deleting from Firebase:', e);
                    }
                }
                
                // Also save to localStorage to update the local copy
                localStorage.setItem('footballTournaments', JSON.stringify(allTournaments));
                console.log('✅ Deleted from localStorage');
                
                if (currentTournamentId === tournamentId) {
                    // Reset to setup page
                    location.href = location.href.split('?')[0];
                }
                alert('Tournament deleted successfully.');
            }
        }

        function showWatchLiveMessage() {
            // Show WATCH LIVE message to everyone (not just admins)
            if (!currentTournamentId) {
                return;
            }
            
            const shareLink = getTournamentShareLink(currentTournamentId);
            const watchLiveDiv = document.getElementById('watchLiveMessage');
            if (watchLiveDiv) {
                watchLiveDiv.style.display = 'block';
                document.getElementById('shareLink').textContent = shareLink;
            } else {
                // Create the watch live message with WhatsApp-style UI (left-aligned)
                const watchLiveHTML = `
                    <div id="watchLiveMessage" style="background: #e7f3e7; border: 2px solid #28a745; border-radius: 10px; padding: 20px; margin: 20px 0;">
                        <h3 style="color: #28a745; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">📺</span>
                            WATCH LIVE
                        </h3>
                        <p style="margin: 5px 0 10px 0; color: #666;">Share this link to let others watch the tournament:</p>
                        <div style="background: white; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid #ddd; word-break: break-all; margin-bottom: 10px; text-align: left; display: block;">
                            <span id="shareLink" style="display: block; text-align: left;">${shareLink}</span>
                        </div>
                        <button id="copyLinkBtn" onclick="copyShareLink()" class="copy-btn">
                            📋 Copy Link
                        </button>
                    </div>
                `;
                const watchLiveContainer = document.getElementById('watchLiveMessageContainer');
                if (watchLiveContainer) {
                    watchLiveContainer.innerHTML = watchLiveHTML;
                }
            }
        }

        function copyShareLink() {
            const shareLink = document.getElementById('shareLink').textContent;
            const btn = document.getElementById('copyLinkBtn');
            const originalText = btn.innerHTML;
            
            navigator.clipboard.writeText(shareLink).then(() => {
                btn.innerHTML = '✅ Copied!';
                btn.style.background = '#128C7E';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#25D366';
                }, 2000);
            }).catch(() => {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = shareLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                btn.innerHTML = '✅ Copied!';
                btn.style.background = '#128C7E';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#25D366';
                }, 2000);
            });
        }

        // Initialize tournaments on page load
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('=== TOURNAMENT MANAGER INITIALIZATION ===');
            console.log('Current URL:', window.location.href);
            console.log('URL Search params:', window.location.search);
            
            // Always show loader page first
            showPage('loaderPage');
            
            // Start UTC time display immediately
            updateDeviceUTC();
            setInterval(updateDeviceUTC, 1000);
            
            // Get tournament ID from URL if present
            const urlParams = new URLSearchParams(window.location.search);
            const tournamentId = urlParams.get('tournament');
            
            console.log('Tournament ID from URL:', tournamentId);
            
            // Initialize Firebase
            initializeFirebase();
            
            // Load tournaments from storage first
            await loadTournamentsFromStorage();
            console.log('Tournaments loaded from storage:', Object.keys(allTournaments));
            
            // Check if we're loading a specific tournament from URL
            if (tournamentId) {
                const loaded = await loadTournamentFromUrl();
                
                if (!loaded) {
                    // Tournament not found - show not found page
                    console.log('Tournament not found, showing error page');
                    // loadTournamentFromUrl already showed the not found page
                }
                // If loaded successfully, loadTournamentFromUrl already showed tournamentDetailPage
                
                // If not using Firebase, start localStorage polling
                if (loaded && !useFirebase) {
                    startRealTimeSync();
                }
            } else {
                // No tournament ID - show create tournament page
                console.log('No tournament to load, showing create page');
                showPage('createTournamentPage');
            }
        });
        
        // Update device UTC time display
        function updateDeviceUTC() {
            const utcElements = document.querySelectorAll('.deviceUTC');
            if (utcElements.length > 0) {
                const now = new Date();
                const hours = now.getUTCHours().toString().padStart(2, '0');
                const minutes = now.getUTCMinutes().toString().padStart(2, '0');
                const seconds = now.getUTCSeconds().toString().padStart(2, '0');
                const timeString = `${hours}:${minutes}:${seconds}`;
                utcElements.forEach(el => {
                    el.textContent = timeString;
                });
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopRealTimeSync();
            
            // Stop Firebase listeners
            if (useFirebase && firebaseStorage) {
                firebaseStorage.stopAllListeners();
            }
        });

        // Real-time synchronization
        let syncInterval = null;
        let lastSyncTime = Date.now();

        function startRealTimeSync() {
            if (!currentTournamentId) return;
            
            console.log('🔄 Starting real-time sync for tournament:', currentTournamentId);
            
            // Listen for storage changes (works across tabs in same browser)
            window.addEventListener('storage', function(e) {
                if (e.key === 'footballTournaments' && currentTournamentId) {
                    console.log('📡 Storage event detected - tournament updated');
                    reloadTournamentData();
                }
            });
            
            // Poll for updates every 2 seconds
            syncInterval = setInterval(function() {
                if (currentTournamentId) {
                    reloadTournamentData();
                }
            }, 2000);
            
            console.log('✅ Real-time sync started (polling every 2 seconds)');
        }

        function stopRealTimeSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
                console.log('🛑 Real-time sync stopped');
            }
        }

        function reloadTournamentData() {
            // Reload tournaments from localStorage
            loadTournamentsFromStorage();
            
            // Get the current tournament
            const tournament = allTournaments[currentTournamentId];
            if (!tournament) {
                console.warn('Tournament no longer exists');
                return;
            }
            
            // Check if there are actual changes (including standings)
            const currentDataString = JSON.stringify({
                matches: matches,
                teams: teams,
                standings: standings,
                playerStats: playerStats,
                keeperStats: keeperStats
            });
            
            const newDataString = JSON.stringify({
                matches: tournament.matches,
                teams: tournament.teams,
                standings: tournament.standings,
                playerStats: tournament.playerStats,
                keeperStats: tournament.keeperStats
            });
            
            // Only update if data has changed
            if (currentDataString !== newDataString) {
                console.log('🔄 Tournament data changed - updating UI');
                
                // Update tournament data
                teams = tournament.teams;
                matches = tournament.matches;
                standings = tournament.standings;
                playerStats = tournament.playerStats || {};
                keeperStats = tournament.keeperStats || {};
                
                // Re-render all views
                renderMatches();
                updateTable();
                updateLeaderboard();
                
                lastSyncTime = Date.now();
            }
            
            // Always update timers for live matches (even if no other changes)
            updateLiveMatchTimers();
        }
        
        function updateLiveMatchTimers() {
            // Only manage intervals: start for live matches, stop for completed matches
            // Each device calculates timer independently from UTC timestamps
            matches.forEach(match => {
                if (match.status === 'live' && match.startTimeUTC) {
                    // Ensure interval is running for live match
                    if (!matchTimers[match.id]) {
                        console.log(`Starting missing interval for live match ${match.id} (sync)`);
                        startCountdownTimer(match.id);
                    }
                } else if (match.status === 'completed' && matchTimers[match.id]) {
                    // Match was completed, stop the timer
                    console.log(`Stopping timer for completed match ${match.id} (localStorage sync)`);
                    clearInterval(matchTimers[match.id]);
                    delete matchTimers[match.id];
                }
            });
        }

        function addPlayer(team) {
            const input = document.getElementById(`${team}PlayerInput`);
            const name = input.value.trim();
            
            if (!name) {
                alert('Please enter a player name');
                return;
            }

            if (teams[team].players.length >= 5) {
                alert('Maximum 5 players per team');
                return;
            }

            teams[team].players.push(name);
            const playerId = `${team}-${name}`;
            playerStats[playerId] = { name: name, team: team, goals: 0, assists: 0, ownGoals: 0 };
            keeperStats[playerId] = { name: name, team: team, saves: 0, cleanSheets: 0 };
            input.value = '';
            renderPlayers(team);
        }

        function removePlayer(team, index) {
            const playerName = teams[team].players[index];
            const playerId = `${team}-${playerName}`;
            delete playerStats[playerId];
            delete keeperStats[playerId];
            teams[team].players.splice(index, 1);
            renderPlayers(team);
        }

        function renderPlayers(team) {
            const container = document.getElementById(`${team}Players`);
            container.innerHTML = teams[team].players.map((player, idx) => `
                <div class="player-item">
                    <span>${player}</span>
                    <button class="remove-btn" onclick="removePlayer('${team}', ${idx})">Remove</button>
                </div>
            `).join('');
        }

        function addTestPlayers() {
            teams.red.players = ['Marcus', 'Diego', 'Andre', 'Carlo', 'Sergio'];
            teams.black.players = ['Kevin', 'Raheem', 'Jack', 'Phil', 'Kyle'];
            teams.white.players = ['Bruno', 'Paul', 'Harry', 'Luke', 'Aaron'];

            playerStats = {};
            keeperStats = {};

            ['red', 'black', 'white'].forEach(team => {
                teams[team].players.forEach(name => {
                    const playerId = `${team}-${name}`;
                    playerStats[playerId] = { name: name, team: team, goals: 0, assists: 0, ownGoals: 0 };
                    keeperStats[playerId] = { name: name, team: team, saves: 0, cleanSheets: 0 };
                });
            });

            renderPlayers('red');
            renderPlayers('black');
            renderPlayers('white');
        }

        function startTournament() {
            for (let team in teams) {
                if (teams[team].players.length === 0) {
                    alert(`Please add at least one player to ${teams[team].name} team`);
                    return;
                }
            }

            // Show admin password modal
            document.getElementById('adminPasswordModal').style.display = 'flex';
        }

        function setAdminPassword() {
            const password = document.getElementById('adminPasswordInput').value;
            const confirm = document.getElementById('adminPasswordConfirm').value;

            if (!password || password.length < 4) {
                alert('Password must be at least 4 characters long');
                return;
            }

            if (password !== confirm) {
                alert('Passwords do not match');
                return;
            }

            adminPassword = password;
            isAdmin = true;
            document.getElementById('adminPasswordModal').style.display = 'none';

            // Generate unique tournament ID
            currentTournamentId = generateTournamentId();
            
            // Store admin session for this tournament
            sessionStorage.setItem(`admin_${currentTournamentId}`, 'true');

            const now = new Date();
            tournamentDate = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

            matches = [];

            for (let round = 1; round <= 3; round++) {
                matches.push({
                    id: matches.length,
                    round: round,
                    team1: 'red',
                    team2: 'black',
                    score1: 0,
                    score2: 0,
                    status: 'pending',
                    startTimeUTC: null,
                    endTimeUTC: null,
                    goals: [],
                    keeper1: null,
                    keeper2: null
                });

                matches.push({
                    id: matches.length,
                    round: round,
                    team1: 'red',
                    team2: 'white',
                    score1: 0,
                    score2: 0,
                    status: 'pending',
                    startTimeUTC: null,
                    endTimeUTC: null,
                    goals: [],
                    keeper1: null,
                    keeper2: null
                });

                matches.push({
                    id: matches.length,
                    round: round,
                    team1: 'black',
                    team2: 'white',
                    score1: 0,
                    score2: 0,
                    status: 'pending',
                    startTimeUTC: null,
                    endTimeUTC: null,
                    goals: [],
                    keeper1: null,
                    keeper2: null
                });
            }

            // Save tournament to storage
            allTournaments[currentTournamentId] = {
                id: currentTournamentId,
                teams: JSON.parse(JSON.stringify(teams)),
                matches: JSON.parse(JSON.stringify(matches)),
                standings: JSON.parse(JSON.stringify(standings)),
                date: tournamentDate,
                adminPassword: adminPassword,
                playerStats: JSON.parse(JSON.stringify(playerStats)),
                keeperStats: JSON.parse(JSON.stringify(keeperStats)),
                created: new Date().toISOString()
            };
            console.log('Saving tournament to storage:', currentTournamentId);
            console.log('Tournament data:', allTournaments[currentTournamentId]);
            saveTournamentToStorage();
            console.log('Tournament saved to localStorage');

            // Update URL to include tournament ID
            const newUrl = getTournamentShareLink(currentTournamentId);
            window.history.pushState({}, '', newUrl);

            // Load the tournament (which will switch to tournament detail page)
            loadTournament(currentTournamentId);
            
            // Show the tournament detail page
            showPage('tournamentDetailPage');
            
            // Show WATCH LIVE message
            showWatchLiveMessage();
            
            generateWhatsAppMessage();
            renderMatches();
            updateTable();
            updateLeaderboard();
        }

        function showAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'flex';
        }

        function closeAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'none';
            document.getElementById('adminLoginInput').value = '';
        }

        function verifyAdminLogin() {
            const enteredPassword = document.getElementById('adminLoginInput').value;
            
            if (enteredPassword === adminPassword) {
                isAdmin = true;
                
                // Store admin session for this tournament
                sessionStorage.setItem(`admin_${currentTournamentId}`, 'true');
                
                document.getElementById('adminLoginModal').style.display = 'none';
                document.getElementById('adminLoginInput').value = '';
                document.getElementById('adminControls').style.display = 'none';
                document.getElementById('adminStatus').style.display = 'block';
                
                // Show admin-only sections (check if they exist)
                const whatsappBox = document.getElementById('whatsappMessageBox');
                if (whatsappBox) {
                    whatsappBox.classList.remove('hidden');
                }
                
                const deleteSection = document.getElementById('deleteTournamentSection');
                if (deleteSection) {
                    deleteSection.style.display = 'block';
                    const deleteBtn = document.getElementById('deleteTournamentBtn');
                    if (deleteBtn) {
                        deleteBtn.onclick = () => deleteTournament(currentTournamentId);
                    }
                }

                // If tournament is complete, show tournament summary section
                if (isTournamentComplete()) {
                    const tournamentSummarySection = document.getElementById('tournamentSummarySection');
                    if (tournamentSummarySection) {
                        tournamentSummarySection.style.display = 'block';
                        generateTournamentSummary();
                    } else {
                        // Tournament is complete but section doesn't exist
                        // Need to reorganize the page with admin privileges
                        pageReorganized = false;
                        reorganizePageForCompletedTournament();
                    }
                }
                
                // Show admin-only elements
                showWatchLiveMessage();
                generateWhatsAppMessage();
                
                // Re-render matches to show admin controls
                renderMatches();
                // No success alert - just login smoothly
            } else {
                alert('Incorrect password');
            }
        }

        async function updateTournamentStorage() {
            if (currentTournamentId && allTournaments[currentTournamentId]) {
                console.log('Saving matches to storage:', matches.map(m => ({ id: m.id, status: m.status, startTimeUTC: m.startTimeUTC, endTimeUTC: m.endTimeUTC })));
                
                allTournaments[currentTournamentId].teams = JSON.parse(JSON.stringify(teams));
                allTournaments[currentTournamentId].matches = JSON.parse(JSON.stringify(matches));
                allTournaments[currentTournamentId].standings = JSON.parse(JSON.stringify(standings));
                allTournaments[currentTournamentId].playerStats = JSON.parse(JSON.stringify(playerStats));
                allTournaments[currentTournamentId].keeperStats = JSON.parse(JSON.stringify(keeperStats));
                await saveTournamentToStorage();
            }
        }

        function logoutAdmin() {
            isAdmin = false;
            
            // Clear admin session
            if (currentTournamentId) {
                sessionStorage.removeItem(`admin_${currentTournamentId}`);
            }
            
            // Hide admin-only sections
            const whatsappBox = document.getElementById('whatsappMessageBox');
            if (whatsappBox) {
                whatsappBox.classList.add('hidden');
                whatsappBox.style.display = 'none';
            }
            
            const deleteSection = document.getElementById('deleteTournamentSection');
            if (deleteSection) {
                deleteSection.style.display = 'none';
            }

            const tournamentSummarySection = document.getElementById('tournamentSummarySection');
            if (tournamentSummarySection) {
                tournamentSummarySection.style.display = 'none';
            }
            
            const adminStatus = document.getElementById('adminStatus');
            const adminControls = document.getElementById('adminControls');
            if (adminStatus) adminStatus.style.display = 'none';
            if (adminControls) adminControls.style.display = 'block';
            
            // Reset the page reorganization flag and reload
            pageReorganized = false;
            
            renderMatches();
        }

        function checkAdmin() {
            if (!isAdmin) {
                alert('Admin access required. Please login to manage the tournament.');
                return false;
            }
            return true;
        }

        function showKeeperModal(matchId) {
            if (!checkAdmin()) return;
            
            currentMatchForKeeper = matchId;
            const match = matches.find(m => m.id === matchId);
            const modal = document.getElementById('keeperModal');
            const content = document.getElementById('keeperSelectionContent');

            content.innerHTML = `
                <div class="keeper-selection">
                    <h3 style="color: ${teams[match.team1].color}">${teams[match.team1].name} Goalkeeper</h3>
                    <select id="keeper1Select" style="width: 100%; padding: 10px; font-size: 16px;">
                        ${teams[match.team1].players.map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                </div>
                <div class="keeper-selection">
                    <h3 style="color: ${teams[match.team2].color}">${teams[match.team2].name} Goalkeeper</h3>
                    <select id="keeper2Select" style="width: 100%; padding: 10px; font-size: 16px;">
                        ${teams[match.team2].players.map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                </div>
            `;

            modal.style.display = 'flex';
        }

        function confirmKeepers() {
            const match = matches.find(m => m.id === currentMatchForKeeper);
            match.keeper1 = document.getElementById('keeper1Select').value;
            match.keeper2 = document.getElementById('keeper2Select').value;
            
            document.getElementById('keeperModal').style.display = 'none';
            startMatch(currentMatchForKeeper);
        }

        function renderMatches() {
            const grid = document.getElementById('matchesGrid');
            
            // When tournament is complete, exclude final match from this grid
            const tournamentComplete = isTournamentComplete();
            const matchesToRender = tournamentComplete 
                ? matches.filter(m => m.round !== 'final')
                : matches;
            
            grid.innerHTML = matchesToRender.map(match => {
                const isFinal = match.round === 'final';
                return `
                    <div class="match-card ${isFinal ? 'final-match' : ''}" id="match-${match.id}">
                        <div class="match-header">
                            <strong>${isFinal ? '🏆 FINAL' : `Round ${match.round} - Match ${(match.id % 3) + 1}`}</strong>
                            <span style="color: ${match.status === 'completed' ? 'green' : match.status === 'live' ? 'red' : 'gray'}">
                                ${match.status.toUpperCase()}
                            </span>
                        </div>

                        ${match.keeper1 && match.keeper2 ? `
                            <div class="keeper-info">
                                <div>🧤 ${teams[match.team1].name}: ${match.keeper1}</div>
                                <div>🧤 ${teams[match.team2].name}: ${match.keeper2}</div>
                            </div>
                        ` : ''}
                        
                        <div class="match-teams">
                            <span style="color: ${teams[match.team1].color}">${teams[match.team1].name}</span>
                            <span class="score">${match.score1} - ${match.score2}</span>
                            <span style="color: ${teams[match.team2].color}">${teams[match.team2].name}</span>
                        </div>

                        <div class="timer" id="timer-${match.id}">${
                            match.status === 'completed' && match.startTimeUTC && match.endTimeUTC
                                ? (() => {
                                    const startTime = new Date(match.startTimeUTC).getTime();
                                    const endTime = new Date(match.endTimeUTC).getTime();
                                    const elapsedSeconds = Math.floor((endTime - startTime) / 1000);
                                    // If match went beyond 10 minutes, show 0:00
                                    const remainingSeconds = elapsedSeconds >= 600 ? 0 : Math.max(0, 600 - elapsedSeconds);
                                    const mins = Math.floor(remainingSeconds / 60);
                                    const secs = remainingSeconds % 60;
                                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                                })()
                                : match.status === 'live' && match.startTimeUTC
                                    ? (() => {
                                        // Calculate current countdown time for live matches
                                        const startTime = new Date(match.startTimeUTC).getTime();
                                        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                                        // Clamp between 0 and 600 to handle clock skew
                                        const remainingSeconds = Math.min(600, Math.max(0, 600 - elapsedSeconds));
                                        const mins = Math.floor(remainingSeconds / 60);
                                        const secs = remainingSeconds % 60;
                                        return `${mins}:${secs.toString().padStart(2, '0')}`;
                                    })()
                                    : '10:00'
                        }</div>

                        <div class="match-controls">
                            ${match.status === 'pending' && isAdmin ? `
                                <button class="btn-success" onclick="showKeeperModal(${match.id})">Start</button>
                            ` : ''}
                            
                            ${match.status === 'live' && isAdmin ? `
                                <button class="btn-primary" onclick="simulateMatch(${match.id})" style="background: #9c27b0;">
                                    🎲 Random
                                </button>
                                <button class="btn-danger" onclick="endMatch(${match.id})">End Match</button>
                            ` : ''}
                        </div>

                        ${match.status === 'live' && isAdmin ? `
                            <div class="goal-section">
                                <h4>Record Events</h4>
                                <div style="margin: 10px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn-warning" onclick="showGoalDialog(${match.id})">Add Goal</button>
                                    <button class="btn-danger" onclick="showOwnGoalDialog(${match.id})">Add Own Goal</button>
                                    <button class="btn-primary" onclick="showSaveDialog(${match.id})">Add Save</button>
                                </div>
                            </div>
                        ` : ''}

                        <div class="goal-log" id="goals-${match.id}">
                            ${match.goals.map(g => `
                                <div class="goal-item ${g.ownGoal ? 'own-goal' : ''} ${g.type === 'save' ? 'save-item' : ''}">
                                    ${g.type === 'save' ? '🧤' : '⚽'} ${g.time}' - ${teams[g.team].name} - ${g.scorer}${g.assist ? ` (Assist: ${g.assist})` : ''}${g.ownGoal ? ' [OWN GOAL]' : ''}${g.type === 'save' ? ' [SAVE]' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            // After rendering, immediately update timer displays for all live matches
            // This ensures accurate display even if intervals haven't ticked yet
            matches.forEach(match => {
                if (match.status === 'live' && match.startTimeUTC) {
                    const startTime = new Date(match.startTimeUTC).getTime();
                    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    // Clamp between 0 and 600 to handle clock skew
                    const remainingSeconds = Math.min(600, Math.max(0, 600 - elapsedSeconds));
                    updateTimerDisplay(match.id, remainingSeconds);
                }
            });

            // Check if tournament is complete and reorganize layout
            reorganizePageForCompletedTournament();
        }

        function startMatch(matchId) {
            const match = matches.find(m => m.id === matchId);
            match.status = 'live';
            match.startTimeUTC = new Date().toISOString();
            match.endTimeUTC = null;
            
            // Start 10-minute countdown timer
            startCountdownTimer(matchId);
            
            renderMatches();
            updateTournamentStorage();
        }
        
        function startCountdownTimer(matchId) {
            const match = matches.find(m => m.id === matchId);
            if (!match || match.status !== 'live') return;
            
            // Calculate how much time has elapsed since start
            const startTime = new Date(match.startTimeUTC).getTime();
            const now = Date.now();
            const elapsedMs = now - startTime;
            const elapsedSeconds = Math.floor(elapsedMs / 1000);
            
            // 10 minutes = 600 seconds
            const totalSeconds = 600;
            let remainingSeconds = totalSeconds - elapsedSeconds;
            
            // Clamp to valid range: 0 to 600 (never exceed 10:00 or go negative)
            if (remainingSeconds < 0) remainingSeconds = 0;
            if (remainingSeconds > 600) remainingSeconds = 600;
            
            // Update display immediately
            updateTimerDisplay(matchId, remainingSeconds);
            
            // Start interval
            matchTimers[matchId] = setInterval(() => {
                const currentElapsed = Math.floor((Date.now() - startTime) / 1000);
                remainingSeconds = totalSeconds - currentElapsed;
                
                // Clamp to valid range: 0 to 600 (handle clock skew between devices)
                if (remainingSeconds < 0) remainingSeconds = 0;
                if (remainingSeconds > 600) remainingSeconds = 600;
                
                if (remainingSeconds <= 0) {
                    updateTimerDisplay(matchId, 0);
                    // Timer stops at 0:00 but match continues until admin ends it
                    clearInterval(matchTimers[matchId]);
                    delete matchTimers[matchId];
                } else {
                    updateTimerDisplay(matchId, remainingSeconds);
                }
            }, 1000);
        }
        
        function updateTimerDisplay(matchId, seconds) {
            const timerElement = document.getElementById(`timer-${matchId}`);
            if (timerElement) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerElement.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function restartLiveMatchTimers() {
            // Restart countdown timers for any live matches after page reload
            // AND stop timers for any completed matches
            matches.forEach(match => {
                if (match.status === 'live' && match.startTimeUTC && !matchTimers[match.id]) {
                    console.log(`Restarting countdown timer for match ${match.id}`);
                    startCountdownTimer(match.id);
                } else if (match.status === 'completed' && matchTimers[match.id]) {
                    // Match was completed (possibly by admin on another device)
                    // Stop the timer on this device
                    console.log(`Stopping timer for completed match ${match.id}`);
                    clearInterval(matchTimers[match.id]);
                    delete matchTimers[match.id];
                }
            });
        }

        function togglePause(matchId) {
            if (!checkAdmin()) return;
            alert('Pause functionality temporarily disabled');
        }

        function simulateMatch(matchId) {
            if (!checkAdmin()) return;
            const match = matches.find(m => m.id === matchId);
            
            // Keep generating events until a team reaches 3 goals
            while (match.score1 < 3 && match.score2 < 3) {
                // Pick random event: 0 = goal, 1 = own goal, 2 = save
                const eventType = Math.floor(Math.random() * 3);
                
                if (eventType === 0) {
                    // Add Goal
                    const scoringTeam = Math.random() > 0.5 ? match.team1 : match.team2;
                    const teamPlayers = teams[scoringTeam].players;
                    const scorer = teamPlayers[Math.floor(Math.random() * teamPlayers.length)];
                    
                    // Random assist (50% chance of having an assist)
                    const hasAssist = Math.random() > 0.5;
                    let assist = '';
                    if (hasAssist) {
                        const otherPlayers = teamPlayers.filter(p => p !== scorer);
                        if (otherPlayers.length > 0) {
                            assist = otherPlayers[Math.floor(Math.random() * otherPlayers.length)];
                        }
                    }
                    
                    const elapsedTime = match.startTimeUTC ? Math.floor((Date.now() - new Date(match.startTimeUTC).getTime()) / 1000) : 0;
                    const minutes = Math.floor(elapsedTime / 60);
                    
                    match.goals.push({
                        team: scoringTeam,
                        scorer: scorer,
                        assist: assist,
                        ownGoal: false,
                        time: minutes,
                        type: 'goal'
                    });
                    
                    const scorerId = `${scoringTeam}-${scorer}`;
                    playerStats[scorerId].goals++;
                    
                    if (assist) {
                        const assistId = `${scoringTeam}-${assist}`;
                        playerStats[assistId].assists++;
                    }
                    
                    if (scoringTeam === match.team1) {
                        match.score1++;
                    } else {
                        match.score2++;
                    }
                    
                } else if (eventType === 1) {
                    // Add Own Goal
                    const ownGoalTeam = Math.random() > 0.5 ? match.team1 : match.team2;
                    const teamPlayers = teams[ownGoalTeam].players;
                    const player = teamPlayers[Math.floor(Math.random() * teamPlayers.length)];
                    
                    const elapsedTime = match.startTimeUTC ? Math.floor((Date.now() - new Date(match.startTimeUTC).getTime()) / 1000) : 0;
                    const minutes = Math.floor(elapsedTime / 60);
                    
                    match.goals.push({
                        team: ownGoalTeam,
                        scorer: player,
                        assist: '',
                        ownGoal: true,
                        time: minutes,
                        type: 'goal'
                    });
                    
                    const playerId = `${ownGoalTeam}-${player}`;
                    if (!playerStats[playerId].ownGoals) playerStats[playerId].ownGoals = 0;
                    playerStats[playerId].ownGoals++;
                    
                    // Own goal goes to opponent
                    if (ownGoalTeam === match.team1) {
                        match.score2++;
                    } else {
                        match.score1++;
                    }
                    
                } else {
                    // Add Save
                    const saveTeam = Math.random() > 0.5 ? match.team1 : match.team2;
                    const keeper = saveTeam === match.team1 ? match.keeper1 : match.keeper2;
                    
                    const elapsedTime = match.startTimeUTC ? Math.floor((Date.now() - new Date(match.startTimeUTC).getTime()) / 1000) : 0;
                    const minutes = Math.floor(elapsedTime / 60);
                    
                    match.goals.push({
                        team: saveTeam,
                        scorer: keeper,
                        assist: '',
                        ownGoal: false,
                        time: minutes,
                        type: 'save'
                    });
                    
                    const keeperId = `${saveTeam}-${keeper}`;
                    keeperStats[keeperId].saves++;
                }
            }
            
            // Match ends when any team reaches 3 goals
            endMatch(matchId);
        }

        function endMatch(matchId) {
            if (!checkAdmin()) return;
            const match = matches.find(m => m.id === matchId);
            
            // Save end time in UTC
            match.endTimeUTC = new Date().toISOString();
            match.status = 'completed';
            
            // Calculate elapsed time for logging
            if (match.startTimeUTC && match.endTimeUTC) {
                const startTime = new Date(match.startTimeUTC).getTime();
                const endTime = new Date(match.endTimeUTC).getTime();
                const elapsedSeconds = Math.floor((endTime - startTime) / 1000);
                console.log('Match ended - Duration:', Math.floor(elapsedSeconds / 60) + ':' + (elapsedSeconds % 60).toString().padStart(2, '0'));
            }
            
            // Clear the interval
            if (matchTimers[matchId]) {
                clearInterval(matchTimers[matchId]);
                delete matchTimers[matchId];
            }

            const keeper1Id = `${match.team1}-${match.keeper1}`;
            const keeper2Id = `${match.team2}-${match.keeper2}`;
            
            if (match.score2 === 0) {
                keeperStats[keeper1Id].cleanSheets++;
            }
            if (match.score1 === 0) {
                keeperStats[keeper2Id].cleanSheets++;
            }

            updateStandings(match);
            
            // Save immediately before rendering to ensure timer is synced
            updateTournamentStorage();
            
            renderMatches();
            updateTable();
            updateLeaderboard();

            const roundRobinMatches = matches.filter(m => m.round !== 'final');
            const allComplete = roundRobinMatches.every(m => m.status === 'completed');
            
            if (allComplete && !matches.some(m => m.round === 'final')) {
                createFinal();
            }
        }

        function showGoalDialog(matchId) {
            if (!checkAdmin()) return;
            
            currentEventMatch = matchId;
            currentEventType = 'goal';
            eventStep = 1;
            eventData = {};
            showEventStep();
        }

        function showOwnGoalDialog(matchId) {
            if (!checkAdmin()) return;
            
            currentEventMatch = matchId;
            currentEventType = 'owngoal';
            eventStep = 1;
            eventData = {};
            showEventStep();
        }

        function showSaveDialog(matchId) {
            if (!checkAdmin()) return;
            
            currentEventMatch = matchId;
            currentEventType = 'save';
            eventStep = 1;
            eventData = {};
            showEventStep();
        }

        function showEventStep() {
            const match = matches.find(m => m.id === currentEventMatch);
            const modal = document.getElementById('eventModal');
            const title = document.getElementById('eventModalTitle');
            const content = document.getElementById('eventModalContent');

            if (currentEventType === 'goal') {
                if (eventStep === 1) {
                    title.textContent = 'Select Team';
                    content.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 10px;" id="teamBtnContainer">
                            <button class="btn-primary" style="padding: 15px;" data-team="${match.team1}">${teams[match.team1].name}</button>
                            <button class="btn-primary" style="padding: 15px;" data-team="${match.team2}">${teams[match.team2].name}</button>
                        </div>
                    `;
                    setTimeout(() => {
                        document.querySelectorAll('#teamBtnContainer button').forEach(btn => {
                            btn.onclick = () => {
                                eventData.team = btn.getAttribute('data-team');
                                eventStep++;
                                showEventStep();
                            };
                        });
                    }, 10);
                } else if (eventStep === 2) {
                    title.textContent = 'Select Scorer';
                    const players = teams[eventData.team].players;
                    content.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto;" id="scorerBtnContainer">
                            ${players.map((p, idx) => `<button class="btn-primary" style="padding: 15px;" data-idx="${idx}">${p}</button>`).join('')}
                        </div>
                    `;
                    setTimeout(() => {
                        document.querySelectorAll('#scorerBtnContainer button').forEach(btn => {
                            btn.onclick = () => {
                                const idx = parseInt(btn.getAttribute('data-idx'));
                                eventData.player = teams[eventData.team].players[idx];
                                eventStep++;
                                showEventStep();
                            };
                        });
                    }, 10);
                } else if (eventStep === 3) {
                    title.textContent = 'Select Assist (Optional)';
                    const players = teams[eventData.team].players.filter(p => p !== eventData.player);
                    content.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto;" id="assistBtnContainer">
                            <button class="btn-primary" style="padding: 15px;" data-none="true">No Assist</button>
                            ${players.map((p, idx) => `<button class="btn-primary" style="padding: 15px;" data-idx="${idx}">${p}</button>`).join('')}
                        </div>
                    `;
                    setTimeout(() => {
                        document.querySelectorAll('#assistBtnContainer button').forEach(btn => {
                            btn.onclick = () => {
                                if (btn.getAttribute('data-none')) {
                                    eventData.assist = '';
                                } else {
                                    const idx = parseInt(btn.getAttribute('data-idx'));
                                    const filteredPlayers = teams[eventData.team].players.filter(p => p !== eventData.player);
                                    eventData.assist = filteredPlayers[idx];
                                }
                                recordGoal(currentEventMatch);
                                closeEventModal();
                            };
                        });
                    }, 10);
                }
            } else if (currentEventType === 'owngoal') {
                if (eventStep === 1) {
                    title.textContent = 'Select Team (Own Goal)';
                    content.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 10px;" id="ownTeamBtnContainer">
                            <button class="btn-primary" style="padding: 15px;" data-team="${match.team1}">${teams[match.team1].name}</button>
                            <button class="btn-primary" style="padding: 15px;" data-team="${match.team2}">${teams[match.team2].name}</button>
                        </div>
                    `;
                    setTimeout(() => {
                        document.querySelectorAll('#ownTeamBtnContainer button').forEach(btn => {
                            btn.onclick = () => {
                                eventData.team = btn.getAttribute('data-team');
                                eventStep++;
                                showEventStep();
                            };
                        });
                    }, 10);
                } else if (eventStep === 2) {
                    title.textContent = 'Select Player (Own Goal)';
                    const players = teams[eventData.team].players;
                    content.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto;" id="ownPlayerBtnContainer">
                            ${players.map((p, idx) => `<button class="btn-primary" style="padding: 15px;" data-idx="${idx}">${p}</button>`).join('')}
                        </div>
                    `;
                    setTimeout(() => {
                        document.querySelectorAll('#ownPlayerBtnContainer button').forEach(btn => {
                            btn.onclick = () => {
                                const idx = parseInt(btn.getAttribute('data-idx'));
                                eventData.player = teams[eventData.team].players[idx];
                                recordOwnGoal(currentEventMatch);
                                closeEventModal();
                            };
                        });
                    }, 10);
                }
            } else if (currentEventType === 'save') {
                if (eventStep === 1) {
                    title.textContent = 'Select Goalkeeper Team';
                    content.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 10px;" id="saveTeamBtnContainer">
                            <button class="btn-primary" style="padding: 15px;" data-team="${match.team1}">${teams[match.team1].name} (${match.keeper1})</button>
                            <button class="btn-primary" style="padding: 15px;" data-team="${match.team2}">${teams[match.team2].name} (${match.keeper2})</button>
                        </div>
                    `;
                    setTimeout(() => {
                        document.querySelectorAll('#saveTeamBtnContainer button').forEach(btn => {
                            btn.onclick = () => {
                                eventData.team = btn.getAttribute('data-team');
                                recordSave(currentEventMatch);
                                closeEventModal();
                            };
                        });
                    }, 10);
                }
            }

            modal.style.display = 'flex';
        }

        function recordGoal(matchId) {
            const match = matches.find(m => m.id === matchId);
            const elapsedTime = match.startTimeUTC ? Math.floor((Date.now() - new Date(match.startTimeUTC).getTime()) / 1000) : 0;
            const minutes = Math.floor(elapsedTime / 60);

            match.goals.push({
                team: eventData.team,
                scorer: eventData.player,
                assist: eventData.assist || '',
                ownGoal: false,
                time: minutes,
                type: 'goal'
            });

            const scorerId = `${eventData.team}-${eventData.player}`;
            playerStats[scorerId].goals++;

            if (eventData.assist) {
                const assistId = `${eventData.team}-${eventData.assist}`;
                playerStats[assistId].assists++;
            }

            if (eventData.team === match.team1) {
                match.score1++;
            } else {
                match.score2++;
            }

            const isFinal = match.round === 'final';
            if (!isFinal && (match.score1 >= 3 || match.score2 >= 3)) {
                endMatch(matchId);
            } else {
                renderMatches();
                updateLeaderboard();
                updateTournamentStorage();
            }
        }

        function recordOwnGoal(matchId) {
            const match = matches.find(m => m.id === matchId);
            const elapsedTime = match.startTimeUTC ? Math.floor((Date.now() - new Date(match.startTimeUTC).getTime()) / 1000) : 0;
            const minutes = Math.floor(elapsedTime / 60);

            match.goals.push({
                team: eventData.team,
                scorer: eventData.player,
                assist: '',
                ownGoal: true,
                time: minutes,
                type: 'goal'
            });

            const scorerId = `${eventData.team}-${eventData.player}`;
            if (!playerStats[scorerId].ownGoals) playerStats[scorerId].ownGoals = 0;
            playerStats[scorerId].ownGoals++;

            if (eventData.team === match.team1) {
                match.score2++;
            } else {
                match.score1++;
            }

            const isFinal = match.round === 'final';
            if (!isFinal && (match.score1 >= 3 || match.score2 >= 3)) {
                endMatch(matchId);
            } else {
                renderMatches();
                updateLeaderboard();
                updateTournamentStorage();
            }
        }

        function recordSave(matchId) {
            const match = matches.find(m => m.id === matchId);
            const keeperTeam = eventData.team;
            const keeper = keeperTeam === match.team1 ? match.keeper1 : match.keeper2;

            const elapsedTime = match.startTimeUTC ? Math.floor((Date.now() - new Date(match.startTimeUTC).getTime()) / 1000) : 0;
            const minutes = Math.floor(elapsedTime / 60);

            match.goals.push({
                team: keeperTeam,
                scorer: keeper,
                assist: '',
                ownGoal: false,
                time: minutes,
                type: 'save'
            });

            const keeperId = `${keeperTeam}-${keeper}`;
            keeperStats[keeperId].saves++;

            renderMatches();
            updateLeaderboard();
            updateTournamentStorage();
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
            currentEventMatch = null;
            currentEventType = null;
            eventStep = 0;
            eventData = {};
        }

        function updateStandings(match) {
            // Don't update standings for final matches
            if (match.round === 'final') {
                return;
            }

            const s1 = standings[match.team1];
            const s2 = standings[match.team2];

            s1.played++;
            s2.played++;
            s1.gf += match.score1;
            s1.ga += match.score2;
            s2.gf += match.score2;
            s2.ga += match.score1;

            if (!s1.cleanSheets) s1.cleanSheets = 0;
            if (!s2.cleanSheets) s2.cleanSheets = 0;

            if (match.score2 === 0) s1.cleanSheets++;
            if (match.score1 === 0) s2.cleanSheets++;

            if (match.score1 > match.score2) {
                s1.won++;
                s1.points += 3;
                s2.lost++;
            } else if (match.score2 > match.score1) {
                s2.won++;
                s2.points += 3;
                s1.lost++;
            } else {
                s1.drawn++;
                s2.drawn++;
                s1.points += 1;
                s2.points += 1;
            }
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            const sorted = Object.entries(standings)
                .map(([key, val]) => ({ key, ...val, gd: val.gf - val.ga, cs: val.cleanSheets || 0 }))
                .sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.gd !== a.gd) return b.gd - a.gd;
                    const h2h = getHeadToHead(a.key, b.key);
                    if (h2h !== 0) return h2h;
                    if (b.gf !== a.gf) return b.gf - a.gf;
                    return b.cs - a.cs;
                });

            tbody.innerHTML = sorted.map((team, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td style="color: ${teams[team.key].color}; font-weight: bold;">${teams[team.key].name}</td>
                    <td>${team.played}</td>
                    <td>${team.won}</td>
                    <td>${team.drawn}</td>
                    <td>${team.lost}</td>
                    <td>${team.gf}</td>
                    <td>${team.ga}</td>
                    <td>${team.gd >= 0 ? '+' : ''}${team.gd}</td>
                    <td>${team.cs}</td>
                    <td><strong>${team.points}</strong></td>
                </tr>
            `).join('');
        }

        function getHeadToHead(team1, team2) {
            const h2hMatches = matches.filter(m => 
                m.status === 'completed' && m.round !== 'final' &&
                ((m.team1 === team1 && m.team2 === team2) || (m.team1 === team2 && m.team2 === team1))
            );

            let points1 = 0;
            let points2 = 0;

            h2hMatches.forEach(m => {
                const isTeam1Home = m.team1 === team1;
                const score1 = isTeam1Home ? m.score1 : m.score2;
                const score2 = isTeam1Home ? m.score2 : m.score1;

                if (score1 > score2) points1 += 3;
                else if (score2 > score1) points2 += 3;
                else { points1 += 1; points2 += 1; }
            });

            return points1 - points2;
        }

        function createFinal() {
            const sorted = Object.entries(standings)
                .map(([key, val]) => ({ key, ...val, gd: val.gf - val.ga, cs: val.cleanSheets || 0 }))
                .sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.gd !== a.gd) return b.gd - a.gd;
                    if (b.gf !== a.gf) return b.gf - a.gf;
                    return b.cs - a.cs;
                });

            // Check if top 3 teams are completely equal
            if (sorted.length >= 3) {
                const top3 = sorted.slice(0, 3);
                const allEqual = top3[0].points === top3[1].points && 
                                 top3[1].points === top3[2].points &&
                                 top3[0].gd === top3[1].gd && 
                                 top3[1].gd === top3[2].gd &&
                                 top3[0].gf === top3[1].gf && 
                                 top3[1].gf === top3[2].gf &&
                                 top3[0].cs === top3[1].cs && 
                                 top3[1].cs === top3[2].cs;
                
                if (allEqual) {
                    // Check if H2H forms a circle (each team beat one, lost to one)
                    const h2h12 = getHeadToHead(top3[0].key, top3[1].key);
                    const h2h13 = getHeadToHead(top3[0].key, top3[2].key);
                    const h2h23 = getHeadToHead(top3[1].key, top3[2].key);
                    
                    // If all H2H are different (not all zeros), it's likely a circle
                    if ((h2h12 !== 0 || h2h13 !== 0 || h2h23 !== 0)) {
                        showTiebreakerSelectionThreeWay(top3);
                        return;
                    }
                }
            }

            // Check if top 2 teams are completely equal
            const top2 = sorted.slice(0, 2);
            
            if (top2[0].points === top2[1].points && 
                top2[0].gd === top2[1].gd && 
                getHeadToHead(top2[0].key, top2[1].key) === 0 &&
                top2[0].gf === top2[1].gf &&
                top2[0].cs === top2[1].cs) {
                
                showTiebreakerSelection(top2);
            } else {
                proceedToFinal(top2[0].key, top2[1].key);
                showQualificationNote(sorted);
            }
        }

        function showTiebreakerSelectionThreeWay(top3) {
            tiebreakerTeams = top3;
            const matchesGrid = document.getElementById('matchesGrid');
            
            const tiebreakerHTML = `
                <div class="tiebreaker-modal">
                    <h3>⚠️ Three-Way Tie - Management Decision Required!</h3>
                    <p style="margin-bottom: 15px; color: #856404;">
                        All three teams are completely tied on Points (${top3[0].points}), Goal Difference (${top3[0].gd >= 0 ? '+' : ''}${top3[0].gd}), 
                        Goals Scored (${top3[0].gf}), and Clean Sheets (${top3[0].cs}). Head-to-Head forms a circle with no clear winner.
                        <br><br>
                        <strong>Please select which TWO teams should advance to the final:</strong>
                    </p>
                    <div style="display: grid; gap: 10px;">
                        <div class="team-option" onclick="selectTiebreakerTeams(0, 1)" style="border-color: #667eea;">
                            <span style="color: ${teams[top3[0].key].color}; font-weight: bold;">${teams[top3[0].key].name}</span> vs 
                            <span style="color: ${teams[top3[1].key].color}; font-weight: bold;">${teams[top3[1].key].name}</span>
                        </div>
                        <div class="team-option" onclick="selectTiebreakerTeams(0, 2)" style="border-color: #667eea;">
                            <span style="color: ${teams[top3[0].key].color}; font-weight: bold;">${teams[top3[0].key].name}</span> vs 
                            <span style="color: ${teams[top3[2].key].color}; font-weight: bold;">${teams[top3[2].key].name}</span>
                        </div>
                        <div class="team-option" onclick="selectTiebreakerTeams(1, 2)" style="border-color: #667eea;">
                            <span style="color: ${teams[top3[1].key].color}; font-weight: bold;">${teams[top3[1].key].name}</span> vs 
                            <span style="color: ${teams[top3[2].key].color}; font-weight: bold;">${teams[top3[2].key].name}</span>
                        </div>
                    </div>
                </div>
            `;
            
            matchesGrid.insertAdjacentHTML('beforeend', tiebreakerHTML);
        }

        function showQualificationNote(sorted) {
            const top2 = sorted.slice(0, 2);
            const team1 = top2[0];
            const team2 = top2[1];
            
            let explanation = `<strong style="color: ${teams[team1.key].color}">${teams[team1.key].name}</strong> and <strong style="color: ${teams[team2.key].color}">${teams[team2.key].name}</strong> qualified for the final. `;
            
            if (team1.points !== team2.points) {
                explanation += `<br><br><strong>Reason:</strong> ${teams[team1.key].name} (${team1.points} pts) and ${teams[team2.key].name} (${team2.points} pts) had the highest points.`;
            } else if (team1.gd !== team2.gd) {
                explanation += `<br><br><strong>Reason:</strong> Tied on points (${team1.points} pts each), but separated by Goal Difference. ${teams[team1.key].name} (${team1.gd >= 0 ? '+' : ''}${team1.gd} GD) finished ahead of ${teams[team2.key].name} (${team2.gd >= 0 ? '+' : ''}${team2.gd} GD).`;
            } else {
                const h2h = getHeadToHead(team1.key, team2.key);
                const h2hDetails = getHeadToHeadDetails(team1.key, team2.key);
                
                if (h2h !== 0) {
                    explanation += `<br><br><strong>Reason:</strong> Tied on points (${team1.points} pts) and Goal Difference (${team1.gd >= 0 ? '+' : ''}${team1.gd}), separated by Head-to-Head record.`;
                    explanation += `<br><br><strong>Head-to-Head between ${teams[team1.key].name} and ${teams[team2.key].name}:</strong>`;
                    explanation += `<br>${h2hDetails.summary}`;
                    explanation += `<br><strong>Result:</strong> ${teams[team1.key].name} earned ${h2hDetails.points1} H2H points vs ${teams[team2.key].name}'s ${h2hDetails.points2} H2H points.`;
                } else if (team1.gf !== team2.gf) {
                    explanation += `<br><br><strong>Reason:</strong> Tied on points, GD, and H2H, separated by Goals Scored. ${teams[team1.key].name} (${team1.gf} goals) scored more than ${teams[team2.key].name} (${team2.gf} goals).`;
                } else if (team1.cs !== team2.cs) {
                    explanation += `<br><br><strong>Reason:</strong> Tied on points, GD, H2H, and Goals Scored, separated by Clean Sheets. ${teams[team1.key].name} (${team1.cs} CS) had more clean sheets than ${teams[team2.key].name} (${team2.cs} CS).`;
                }
            }
            
            const noteDiv = document.getElementById('qualificationNote');
            const detailsDiv = document.getElementById('qualificationDetails');
            detailsDiv.innerHTML = explanation;
            noteDiv.style.display = 'block';
        }

        function getHeadToHeadDetails(team1, team2) {
            const h2hMatches = matches.filter(m => 
                m.status === 'completed' && m.round !== 'final' &&
                ((m.team1 === team1 && m.team2 === team2) || (m.team1 === team2 && m.team2 === team1))
            );

            let points1 = 0;
            let points2 = 0;
            let summary = '';

            h2hMatches.forEach((m, idx) => {
                const isTeam1Home = m.team1 === team1;
                const score1 = isTeam1Home ? m.score1 : m.score2;
                const score2 = isTeam1Home ? m.score2 : m.score1;

                summary += `Round ${m.round}: ${teams[team1].name} ${score1}-${score2} ${teams[team2].name}`;
                
                if (score1 > score2) {
                    points1 += 3;
                    summary += ` (${teams[team1].name} won)`;
                } else if (score2 > score1) {
                    points2 += 3;
                    summary += ` (${teams[team2].name} won)`;
                } else {
                    points1 += 1;
                    points2 += 1;
                    summary += ` (Draw)`;
                }
                
                if (idx < h2hMatches.length - 1) summary += '<br>';
            });

            return { points1, points2, summary };
        }

        function showTiebreakerSelection(top2) {
            tiebreakerTeams = top2;
            const matchesGrid = document.getElementById('matchesGrid');
            
            const tiebreakerHTML = `
                <div class="tiebreaker-modal">
                    <h3>⚠️ Tiebreaker Required - All Stats Equal!</h3>
                    <p style="margin-bottom: 15px; color: #856404;">
                        Both teams are completely tied. Please select which teams should advance to the final:
                    </p>
                    <div style="display: grid; gap: 10px;">
                        <div class="team-option" onclick="selectTiebreakerTeams(0, 1)" style="color: ${teams[top2[0].key].color}; border-color: ${teams[top2[0].key].color};">
                            1. ${teams[top2[0].key].name} vs ${teams[top2[1].key].name}
                        </div>
                    </div>
                </div>
            `;
            
            matchesGrid.insertAdjacentHTML('beforeend', tiebreakerHTML);
        }

        function selectTiebreakerTeams(idx1, idx2) {
            if (!checkAdmin()) return;
            
            const team1 = tiebreakerTeams[idx1].key;
            const team2 = tiebreakerTeams[idx2].key;
            
            document.querySelector('.tiebreaker-modal').remove();
            proceedToFinal(team1, team2);
        }

        function proceedToFinal(team1, team2) {
            matches.push({
                id: matches.length,
                round: 'final',
                team1: team1,
                team2: team2,
                score1: 0,
                score2: 0,
                status: 'pending',
                timer: 600,
                interval: null,
                goals: [],
                keeper1: null,
                keeper2: null,
                paused: false
            });

            // Save the final match to Firebase
            updateTournamentStorage();

            renderMatches();
            
            if (tiebreakerTeams && tiebreakerTeams.length === 3) {
                const noteDiv = document.getElementById('qualificationNote');
                const detailsDiv = document.getElementById('qualificationDetails');
                detailsDiv.innerHTML = `<strong style="color: ${teams[team1].color}">${teams[team1].name}</strong> and <strong style="color: ${teams[team2].color}">${teams[team2].name}</strong> qualified for the final.<br><br><strong>Reason:</strong> Three-way tie with all metrics equal. Selected by management decision.`;
                noteDiv.style.display = 'block';
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function formatElapsedTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function isTournamentComplete() {
            // Tournament is complete if the final match exists and is completed
            const finalMatch = matches.find(m => m.round === 'final');
            return finalMatch && finalMatch.status === 'completed';
        }

        function reorganizePageForCompletedTournament() {
            if (!isTournamentComplete()) {
                pageReorganized = false; // Reset flag if tournament not complete
                return; // Not complete yet, keep normal layout
            }

            // Only reorganize once - prevent multiple reorganizations
            if (pageReorganized) {
                return;
            }

            console.log('🔄 Reorganizing page for completed tournament...');
            
            const finalMatch = matches.find(m => m.round === 'final');
            const winner = finalMatch.score1 > finalMatch.score2 ? finalMatch.team1 : finalMatch.team2;

            // Get the main container
            const detailPage = document.getElementById('tournamentDetailPage');
            
            // Get header (first child)
            const header = detailPage.querySelector('div:first-child');

            // Remove all children except header
            const allChildren = Array.from(detailPage.children);
            allChildren.forEach(child => {
                if (child !== header) {
                    child.remove();
                }
            });

            // Now add sections in the correct order
            
            // 1. Header (already there)
            
            // 2. TOURNAMENT WINNER
            const winnerSection = document.createElement('div');
            winnerSection.id = 'winnerSection';
            winnerSection.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h1 style="font-size: 2.5em; margin: 0 0 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                        🏆 TOURNAMENT WINNER 🏆
                    </h1>
                    <div style="font-size: 3em; margin: 20px 0; font-weight: bold; text-shadow: 3px 3px 6px rgba(0,0,0,0.3);">
                        ${teams[winner].name.toUpperCase()}
                    </div>
                    <div style="font-size: 1.2em; opacity: 0.9;">
                        🎉 Congratulations! 🎉
                    </div>
                </div>
            `;
            detailPage.appendChild(winnerSection);

            // 3. FINAL MATCH
            const finalMatchSection = document.createElement('div');
            finalMatchSection.id = 'finalMatchSection';
            finalMatchSection.className = 'section';
            finalMatchSection.innerHTML = `
                <h2>🏆 Final Match</h2>
                <div class="matches-grid">
                    ${separateFinalMatch()}
                </div>
            `;
            detailPage.appendChild(finalMatchSection);

            // 4. TOP PERFORMERS
            const topLeaderboardSection = createTopLeaderboardSection();
            detailPage.appendChild(topLeaderboardSection);

            // 5. POINTS TABLE
            const tableSection = document.createElement('div');
            tableSection.className = 'section';
            tableSection.id = 'tableSection';
            tableSection.innerHTML = `
                <h2>Points Table</h2>
                <table class="points-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Team</th>
                            <th>P</th>
                            <th>W</th>
                            <th>D</th>
                            <th>L</th>
                            <th>GF</th>
                            <th>GA</th>
                            <th>GD</th>
                            <th>CS</th>
                            <th>Pts</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    <strong>* Tiebreaker Order:</strong> 1. Points, 2. Goal Difference (GD), 3. Head-to-Head (H2H), 4. Goals Scored (GF), 5. Clean Sheets (CS)
                </div>
                <div id="qualificationNote" style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 5px; font-size: 0.9em; display: none;">
                    <strong style="color: #1976D2;">📋 Final Qualification:</strong>
                    <div id="qualificationDetails" style="margin-top: 8px; color: #555;"></div>
                </div>
            `;
            detailPage.appendChild(tableSection);
            updateTable(); // Re-populate the table

            // 6. LEADERBOARD
            const leaderboardSection = document.createElement('div');
            leaderboardSection.className = 'section';
            leaderboardSection.id = 'leaderboardSection';
            leaderboardSection.innerHTML = `
                <h2>Leaderboard</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #ffc107;">
                        <h3 style="color: #ffc107; margin-bottom: 10px;">⚽ Top Scorers</h3>
                        <div id="topScorers" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                        <h3 style="color: #667eea; margin-bottom: 10px;">🎯 Top Assists</h3>
                        <div id="topAssists" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #dc3545;">
                        <h3 style="color: #dc3545; margin-bottom: 10px;">😬 Own Goals</h3>
                        <div id="ownGoals" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #28a745;">
                        <h3 style="color: #28a745; margin-bottom: 10px;">🧤 Keeper Saves</h3>
                        <div id="topKeeper" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #17a2b8;">
                        <h3 style="color: #17a2b8; margin-bottom: 10px;">🛡️ Clean Sheets (Teams)</h3>
                        <div id="mostCleanSheets" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #d32f2f;">
                        <h3 style="color: #d32f2f; margin-bottom: 10px;">🔥 Goals Scored (Teams)</h3>
                        <div id="mostGoals" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #ff6b6b;">
                        <h3 style="color: #ff6b6b; margin-bottom: 10px;">⚠️ Goals Conceded (Teams)</h3>
                        <div id="mostConceded" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 10px; border-left: 4px solid #6f42c1;">
                        <h3 style="color: #6f42c1; margin-bottom: 10px;">📊 Goal Difference (Teams)</h3>
                        <div id="bestGD" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            `;
            detailPage.appendChild(leaderboardSection);
            updateLeaderboard(); // Re-populate leaderboard

            // 7. LEAGUE MATCHES (without final)
            const matchesSection = document.createElement('div');
            matchesSection.className = 'section';
            matchesSection.id = 'matchesSection';
            matchesSection.innerHTML = `
                <h2>League Matches</h2>
                <div class="matches-grid" id="matchesGrid"></div>
            `;
            detailPage.appendChild(matchesSection);
            
            // Re-render matches (will exclude final due to filter in renderMatches)
            const grid = document.getElementById('matchesGrid');
            const leagueMatches = matches.filter(m => m.round !== 'final');
            grid.innerHTML = leagueMatches.map(match => {
                const isFinal = false;
                return `
                    <div class="match-card" id="match-${match.id}">
                        <div class="match-header">
                            <strong>Round ${match.round} - Match ${(match.id % 3) + 1}</strong>
                            <span style="color: ${match.status === 'completed' ? 'green' : match.status === 'live' ? 'red' : 'gray'}">
                                ${match.status.toUpperCase()}
                            </span>
                        </div>

                        ${match.keeper1 && match.keeper2 ? `
                            <div class="keeper-info">
                                <div>🧤 ${teams[match.team1].name}: ${match.keeper1}</div>
                                <div>🧤 ${teams[match.team2].name}: ${match.keeper2}</div>
                            </div>
                        ` : ''}
                        
                        <div class="match-teams">
                            <span style="color: ${teams[match.team1].color}">${teams[match.team1].name}</span>
                            <span class="score">${match.score1} - ${match.score2}</span>
                            <span style="color: ${teams[match.team2].color}">${teams[match.team2].name}</span>
                        </div>

                        <div class="timer" id="timer-${match.id}">${
                            match.status === 'completed' && match.startTimeUTC && match.endTimeUTC
                                ? (() => {
                                    const startTime = new Date(match.startTimeUTC).getTime();
                                    const endTime = new Date(match.endTimeUTC).getTime();
                                    const elapsedSeconds = Math.floor((endTime - startTime) / 1000);
                                    const remainingSeconds = elapsedSeconds >= 600 ? 0 : Math.max(0, 600 - elapsedSeconds);
                                    const mins = Math.floor(remainingSeconds / 60);
                                    const secs = remainingSeconds % 60;
                                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                                })()
                                : '10:00'
                        }</div>

                        <div class="goal-log" id="goals-${match.id}">
                            ${match.goals.map(g => `
                                <div class="goal-item ${g.ownGoal ? 'own-goal' : ''} ${g.type === 'save' ? 'save-item' : ''}">
                                    ${g.type === 'save' ? '🧤' : '⚽'} ${g.time}' - ${teams[g.team].name} - ${g.scorer}${g.assist ? ` (Assist: ${g.assist})` : ''}${g.ownGoal ? ' [OWN GOAL]' : ''}${g.type === 'save' ? ' [SAVE]' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // 8. TOURNAMENT SUMMARY (admin only)
            if (isAdmin) {
                const tournamentSummarySection = document.createElement('div');
                tournamentSummarySection.className = 'section';
                tournamentSummarySection.id = 'tournamentSummarySection';
                tournamentSummarySection.innerHTML = `
                    <h2>Tournament Summary</h2>
                    <div class="whatsapp-message-box">
                        <h3>
                            <span style="font-size: 1.5em;">📱</span>
                            WhatsApp Summary - Share Tournament Results
                        </h3>
                        <div class="message-content" id="summaryMessageContent"></div>
                        <button class="copy-btn" onclick="copySummaryMessage()">
                            📋 Copy Summary
                        </button>
                    </div>
                `;
                detailPage.appendChild(tournamentSummarySection);
                generateTournamentSummary();
            }

            // 9. TOURNAMENT LINK
            const tournamentLinkContainer = document.createElement('div');
            tournamentLinkContainer.id = 'tournamentLinkContainer';
            tournamentLinkContainer.className = 'section';
            const shareLink = getTournamentShareLink(currentTournamentId);
            tournamentLinkContainer.innerHTML = `
                <div style="background: #e7f3e7; border: 2px solid #28a745; border-radius: 10px; padding: 20px;">
                    <h3 style="color: #28a745; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">🔗</span>
                        TOURNAMENT LINK
                    </h3>
                    <p style="margin: 5px 0 10px 0; color: #666;">Share this link to view the tournament results:</p>
                    <div style="background: white; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid #ddd; word-break: break-all; margin-bottom: 10px; text-align: left; display: block;">
                        <span id="shareLinkCompleted" style="display: block; text-align: left;">${shareLink}</span>
                    </div>
                    <button id="copyLinkBtnCompleted" onclick="copyShareLinkCompleted()" class="copy-btn">
                        📋 Copy Link
                    </button>
                </div>
            `;
            detailPage.appendChild(tournamentLinkContainer);

            // 10. DELETE TOURNAMENT (admin only)
            if (isAdmin) {
                const deleteTournamentSection = document.createElement('div');
                deleteTournamentSection.id = 'deleteTournamentSection';
                deleteTournamentSection.className = 'section';
                deleteTournamentSection.style.textAlign = 'center';
                deleteTournamentSection.style.marginTop = '30px';
                deleteTournamentSection.innerHTML = `
                    <button id="deleteTournamentBtn" class="btn-danger" style="padding: 12px 30px; font-size: 16px;" onclick="deleteTournament('${currentTournamentId}')">
                        🗑️ Delete Tournament
                    </button>
                `;
                detailPage.appendChild(deleteTournamentSection);
            }

            // Footer (version and UTC)
            const footer = document.createElement('div');
            footer.style.cssText = 'margin-top: 30px; padding: 20px; display: flex; justify-content: space-between; align-items: center; color: #999; font-size: 0.75em; border-top: 1px solid #eee;';
            footer.innerHTML = `
                <span>v1.5.7</span>
                <span>UTC: <span class="deviceUTC">--</span></span>
            `;
            detailPage.appendChild(footer);

            // Mark as reorganized
            pageReorganized = true;
            console.log('✅ Page reorganization complete');
        }

        function createTopLeaderboardSection() {
            const topLeaderboardSection = document.createElement('div');
            topLeaderboardSection.id = 'topLeaderboardSection';
            topLeaderboardSection.className = 'section';

            const stats = generateLeaderboardStats();

            topLeaderboardSection.innerHTML = `
                <h2>🏅 Top Performers</h2>
                <div style="background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 15px;">
                            🏅 INDIVIDUAL AWARDS
                        </h3>
                        
                        ${stats.topScorers.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #ffc107; margin-bottom: 10px;">⚽ TOP SCORER${stats.topScorers.length > 1 ? 'S' : ''}</h4>
                                ${stats.topScorers.map(p => `
                                    <div style="padding: 8px; background: #fff8e1; border-left: 4px solid #ffc107; margin-bottom: 5px; border-radius: 4px;">
                                        🥇 <strong>${p.name}</strong> (${teams[p.team].name}) - ${p.goals} goal${p.goals > 1 ? 's' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${stats.topAssisters.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #667eea; margin-bottom: 10px;">🎯 TOP ASSIST${stats.topAssisters.length > 1 ? 'S' : ''}</h4>
                                ${stats.topAssisters.map(p => `
                                    <div style="padding: 8px; background: #e8eaf6; border-left: 4px solid #667eea; margin-bottom: 5px; border-radius: 4px;">
                                        🥇 <strong>${p.name}</strong> (${teams[p.team].name}) - ${p.assists} assist${p.assists > 1 ? 's' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${stats.topKeepers.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #28a745; margin-bottom: 10px;">🧤 BEST GOALKEEPER${stats.topKeepers.length > 1 ? 'S' : ''}</h4>
                                ${stats.topKeepers.map(k => `
                                    <div style="padding: 8px; background: #e8f5e9; border-left: 4px solid #28a745; margin-bottom: 5px; border-radius: 4px;">
                                        🥇 <strong>${k.name}</strong> (${teams[k.team].name}) - ${k.saves} save${k.saves > 1 ? 's' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${stats.ownGoalScorers.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #dc3545; margin-bottom: 10px;">😬 OWN GOAL${stats.ownGoalScorers.length > 1 ? 'S' : ''}</h4>
                                ${stats.ownGoalScorers.map(p => `
                                    <div style="padding: 8px; background: #ffebee; border-left: 4px solid #dc3545; margin-bottom: 5px; border-radius: 4px;">
                                        • <strong>${p.name}</strong> (${teams[p.team].name}) - ${p.ownGoals}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <div>
                        <h3 style="color: #764ba2; border-bottom: 2px solid #764ba2; padding-bottom: 10px; margin-bottom: 15px;">
                            🏆 TEAM AWARDS
                        </h3>

                        ${stats.bestAttack.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #d32f2f; margin-bottom: 10px;">🔥 BEST ATTACK - MOST GOALS SCORED</h4>
                                ${stats.bestAttack.map(t => `
                                    <div style="padding: 8px; background: #ffebee; border-left: 4px solid #d32f2f; margin-bottom: 5px; border-radius: 4px;">
                                        <strong>${teams[t.key].name}</strong> - ${t.gf} goals
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${stats.bestDefense.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #1976d2; margin-bottom: 10px;">🛡️ BEST DEFENSE - LEAST GOALS CONCEDED</h4>
                                ${stats.bestDefense.map(t => `
                                    <div style="padding: 8px; background: #e3f2fd; border-left: 4px solid #1976d2; margin-bottom: 5px; border-radius: 4px;">
                                        <strong>${teams[t.key].name}</strong> - ${t.ga} goals conceded
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${stats.mostCleanSheets.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #17a2b8; margin-bottom: 10px;">🧤 MOST CLEAN SHEETS</h4>
                                ${stats.mostCleanSheets.map(t => `
                                    <div style="padding: 8px; background: #e0f7fa; border-left: 4px solid #17a2b8; margin-bottom: 5px; border-radius: 4px;">
                                        <strong>${teams[t.key].name}</strong> - ${t.cs} clean sheets
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            return topLeaderboardSection;
        }

        function separateFinalMatch() {
            // Find and return the final match HTML, remove it from main matches grid
            const finalMatch = matches.find(m => m.round === 'final');
            if (!finalMatch) return null;

            const isFinal = true;
            return `
                <div class="match-card final-match" id="match-${finalMatch.id}">
                    <div class="match-header">
                        <strong>🏆 FINAL</strong>
                        <span style="color: ${finalMatch.status === 'completed' ? 'green' : finalMatch.status === 'live' ? 'red' : 'gray'}">
                            ${finalMatch.status.toUpperCase()}
                        </span>
                    </div>

                    ${finalMatch.keeper1 && finalMatch.keeper2 ? `
                        <div class="keeper-info">
                            <div>🧤 ${teams[finalMatch.team1].name}: ${finalMatch.keeper1}</div>
                            <div>🧤 ${teams[finalMatch.team2].name}: ${finalMatch.keeper2}</div>
                        </div>
                    ` : ''}
                    
                    <div class="match-teams">
                        <span style="color: ${teams[finalMatch.team1].color}">${teams[finalMatch.team1].name}</span>
                        <span class="score">${finalMatch.score1} - ${finalMatch.score2}</span>
                        <span style="color: ${teams[finalMatch.team2].color}">${teams[finalMatch.team2].name}</span>
                    </div>

                    <div class="timer" id="timer-${finalMatch.id}">${
                        finalMatch.status === 'completed' && finalMatch.startTimeUTC && finalMatch.endTimeUTC
                            ? (() => {
                                const startTime = new Date(finalMatch.startTimeUTC).getTime();
                                const endTime = new Date(finalMatch.endTimeUTC).getTime();
                                const elapsedSeconds = Math.floor((endTime - startTime) / 1000);
                                const remainingSeconds = elapsedSeconds >= 600 ? 0 : Math.max(0, 600 - elapsedSeconds);
                                const mins = Math.floor(remainingSeconds / 60);
                                const secs = remainingSeconds % 60;
                                return `${mins}:${secs.toString().padStart(2, '0')}`;
                            })()
                            : '10:00'
                    }</div>

                    <div class="goal-log" id="goals-${finalMatch.id}">
                        ${finalMatch.goals.map(g => `
                            <div class="goal-item ${g.ownGoal ? 'own-goal' : ''} ${g.type === 'save' ? 'save-item' : ''}">
                                ${g.type === 'save' ? '🧤' : '⚽'} ${g.time}' - ${teams[g.team].name} - ${g.scorer}${g.assist ? ` (Assist: ${g.assist})` : ''}${g.ownGoal ? ' [OWN GOAL]' : ''}${g.type === 'save' ? ' [SAVE]' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderWinnerSection(winnerTeam) {
            const winnerSection = document.getElementById('winnerSection');
            if (!winnerSection) return;

            const winnerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                    <h1 style="font-size: 2.5em; margin: 0 0 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                        🏆 TOURNAMENT WINNER 🏆
                    </h1>
                    <div style="font-size: 3em; margin: 20px 0; font-weight: bold; text-shadow: 3px 3px 6px rgba(0,0,0,0.3);">
                        ${teams[winnerTeam].name.toUpperCase()}
                    </div>
                    <div style="font-size: 1.2em; opacity: 0.9;">
                        🎉 Congratulations! 🎉
                    </div>
                </div>
            `;

            winnerSection.innerHTML = winnerHTML;
            
            // Move winner section to the top (after header)
            const detailPage = document.getElementById('tournamentDetailPage');
            const header = detailPage.querySelector('div:first-child');
            if (header && header.nextSibling) {
                detailPage.insertBefore(winnerSection, header.nextSibling);
            }
        }

        function renderTopLeaderboard() {
            // Create top leaderboard section if it doesn't exist
            let topLeaderboardSection = document.getElementById('topLeaderboardSection');
            if (!topLeaderboardSection) {
                topLeaderboardSection = document.createElement('div');
                topLeaderboardSection.id = 'topLeaderboardSection';
                topLeaderboardSection.className = 'section';
                
                // Insert after matches section
                const matchesSection = document.getElementById('matchesSection');
                if (matchesSection && matchesSection.nextSibling) {
                    matchesSection.parentNode.insertBefore(topLeaderboardSection, matchesSection.nextSibling);
                }
            }

            // Generate leaderboard stats
            const stats = generateLeaderboardStats();

            const html = `
                <h2>🏅 Top Performers</h2>
                <div style="background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 15px;">
                            🏅 INDIVIDUAL AWARDS
                        </h3>
                        
                        ${stats.topScorers.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #ffc107; margin-bottom: 10px;">⚽ TOP SCORER${stats.topScorers.length > 1 ? 'S' : ''}</h4>
                                ${stats.topScorers.map(p => `
                                    <div style="padding: 8px; background: #fff8e1; border-left: 4px solid #ffc107; margin-bottom: 5px; border-radius: 4px;">
                                        🥇 <strong>${p.name}</strong> (${teams[p.team].name}) - ${p.goals} goal${p.goals > 1 ? 's' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${stats.topAssisters.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #667eea; margin-bottom: 10px;">🎯 TOP ASSIST${stats.topAssisters.length > 1 ? 'S' : ''}</h4>
                                ${stats.topAssisters.map(p => `
                                    <div style="padding: 8px; background: #e8eaf6; border-left: 4px solid #667eea; margin-bottom: 5px; border-radius: 4px;">
                                        🥇 <strong>${p.name}</strong> (${teams[p.team].name}) - ${p.assists} assist${p.assists > 1 ? 's' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${stats.topKeepers.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #28a745; margin-bottom: 10px;">🧤 BEST GOALKEEPER${stats.topKeepers.length > 1 ? 'S' : ''}</h4>
                                ${stats.topKeepers.map(k => `
                                    <div style="padding: 8px; background: #e8f5e9; border-left: 4px solid #28a745; margin-bottom: 5px; border-radius: 4px;">
                                        🥇 <strong>${k.name}</strong> (${teams[k.team].name}) - ${k.saves} save${k.saves > 1 ? 's' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${stats.ownGoalScorers.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #dc3545; margin-bottom: 10px;">😬 OWN GOAL${stats.ownGoalScorers.length > 1 ? 'S' : ''}</h4>
                                ${stats.ownGoalScorers.map(p => `
                                    <div style="padding: 8px; background: #ffebee; border-left: 4px solid #dc3545; margin-bottom: 5px; border-radius: 4px;">
                                        • <strong>${p.name}</strong> (${teams[p.team].name}) - ${p.ownGoals}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <div>
                        <h3 style="color: #764ba2; border-bottom: 2px solid #764ba2; padding-bottom: 10px; margin-bottom: 15px;">
                            🏆 TEAM AWARDS
                        </h3>

                        ${stats.bestAttack.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #d32f2f; margin-bottom: 10px;">🔥 BEST ATTACK - MOST GOALS SCORED</h4>
                                ${stats.bestAttack.map(t => `
                                    <div style="padding: 8px; background: #ffebee; border-left: 4px solid #d32f2f; margin-bottom: 5px; border-radius: 4px;">
                                        <strong>${teams[t.key].name}</strong> - ${t.gf} goals
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${stats.bestDefense.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #1976d2; margin-bottom: 10px;">🛡️ BEST DEFENSE - LEAST GOALS CONCEDED</h4>
                                ${stats.bestDefense.map(t => `
                                    <div style="padding: 8px; background: #e3f2fd; border-left: 4px solid #1976d2; margin-bottom: 5px; border-radius: 4px;">
                                        <strong>${teams[t.key].name}</strong> - ${t.ga} goals conceded
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${stats.mostCleanSheets.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #17a2b8; margin-bottom: 10px;">🧤 MOST CLEAN SHEETS</h4>
                                ${stats.mostCleanSheets.map(t => `
                                    <div style="padding: 8px; background: #e0f7fa; border-left: 4px solid #17a2b8; margin-bottom: 5px; border-radius: 4px;">
                                        <strong>${teams[t.key].name}</strong> - ${t.cs} clean sheets
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            topLeaderboardSection.innerHTML = html;
            return topLeaderboardSection;
        }

        function generateLeaderboardStats() {
            // Get sorted standings (excluding final match stats)
            const sorted = Object.entries(standings)
                .map(([key, val]) => ({ key, ...val, gd: val.gf - val.ga, cs: val.cleanSheets || 0 }))
                .sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.gd !== a.gd) return b.gd - a.gd;
                    if (b.gf !== a.gf) return b.gf - a.gf;
                    return b.cs - a.cs;
                });

            // Top Scorers
            const topScorersArr = Object.values(playerStats)
                .filter(p => p.goals > 0)
                .sort((a, b) => b.goals - a.goals);
            const topScorers = topScorersArr.length > 0 
                ? topScorersArr.filter(p => p.goals === topScorersArr[0].goals)
                : [];

            // Top Assisters
            const topAssistsArr = Object.values(playerStats)
                .filter(p => p.assists > 0)
                .sort((a, b) => b.assists - a.assists);
            const topAssisters = topAssistsArr.length > 0
                ? topAssistsArr.filter(p => p.assists === topAssistsArr[0].assists)
                : [];

            // Top Keepers
            const topKeeperArr = Object.values(keeperStats)
                .filter(k => k.saves > 0)
                .sort((a, b) => b.saves - a.saves);
            const topKeepers = topKeeperArr.length > 0
                ? topKeeperArr.filter(k => k.saves === topKeeperArr[0].saves)
                : [];

            // Own Goal Scorers
            const ownGoalsArr = Object.values(playerStats)
                .filter(p => p.ownGoals && p.ownGoals > 0)
                .sort((a, b) => b.ownGoals - a.ownGoals);
            const ownGoalScorers = ownGoalsArr.length > 0
                ? ownGoalsArr.filter(p => p.ownGoals === ownGoalsArr[0].ownGoals)
                : [];

            // Best Attack (most goals)
            const maxGoals = sorted[0].gf;
            const bestAttack = sorted.filter(t => t.gf === maxGoals);

            // Best Defense (least goals conceded)
            const minConceded = [...sorted].sort((a, b) => a.ga - b.ga)[0].ga;
            const bestDefense = sorted.filter(t => t.ga === minConceded);

            // Most Clean Sheets
            const maxCS = [...sorted].sort((a, b) => b.cs - a.cs)[0].cs;
            const mostCleanSheets = sorted.filter(t => t.cs === maxCS);

            return {
                topScorers,
                topAssisters,
                topKeepers,
                ownGoalScorers,
                bestAttack,
                bestDefense,
                mostCleanSheets
            };
        }

        function renderTournamentLinkSection() {
            // Create or get the tournament link container
            let tournamentLinkContainer = document.getElementById('tournamentLinkContainer');
            if (!tournamentLinkContainer) {
                tournamentLinkContainer = document.createElement('div');
                tournamentLinkContainer.id = 'tournamentLinkContainer';
                tournamentLinkContainer.className = 'section';
            }

            const shareLink = getTournamentShareLink(currentTournamentId);
            
            const linkHTML = `
                <div style="background: #e7f3e7; border: 2px solid #28a745; border-radius: 10px; padding: 20px;">
                    <h3 style="color: #28a745; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">🔗</span>
                        TOURNAMENT LINK
                    </h3>
                    <p style="margin: 5px 0 10px 0; color: #666;">Share this link to view the tournament results:</p>
                    <div style="background: white; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid #ddd; word-break: break-all; margin-bottom: 10px; text-align: left; display: block;">
                        <span id="shareLinkCompleted" style="display: block; text-align: left;">${shareLink}</span>
                    </div>
                    <button id="copyLinkBtnCompleted" onclick="copyShareLinkCompleted()" class="copy-btn">
                        📋 Copy Link
                    </button>
                </div>
            `;

            tournamentLinkContainer.innerHTML = linkHTML;
            return tournamentLinkContainer;
        }

        function copyShareLinkCompleted() {
            const shareLink = document.getElementById('shareLinkCompleted').textContent;
            const btn = document.getElementById('copyLinkBtnCompleted');
            const originalText = btn.innerHTML;
            
            navigator.clipboard.writeText(shareLink).then(() => {
                btn.innerHTML = '✅ Copied!';
                btn.style.background = '#128C7E';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#25D366';
                }, 2000);
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = shareLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                btn.innerHTML = '✅ Copied!';
                btn.style.background = '#128C7E';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#25D366';
                }, 2000);
            });
        }

        function generateTournamentSummary() {
            const summaryContent = document.getElementById('summaryMessageContent');
            if (!summaryContent) return;

            // Get the final match
            const finalMatch = matches.find(m => m.round === 'final');
            if (!finalMatch || finalMatch.status !== 'completed') return;

            const winner = finalMatch.score1 > finalMatch.score2 ? finalMatch.team1 : finalMatch.team2;
            const stats = generateLeaderboardStats();
            const shareLink = getTournamentShareLink(currentTournamentId);

            let message = `🏆 *FOOTBALL TOURNAMENT RESULTS* 🏆\n\n`;
            message += `📅 *Date:* ${tournamentDate}\n\n`;
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            message += `🏆 *CHAMPION*\n`;
            message += `👑 ${teams[winner].name.toUpperCase()} 👑\n\n`;
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            // Individual Awards
            message += `🏅 *INDIVIDUAL AWARDS*\n\n`;
            
            if (stats.topScorers.length > 0) {
                message += `⚽ *TOP SCORER${stats.topScorers.length > 1 ? 'S' : ''}*\n`;
                stats.topScorers.forEach(p => {
                    message += `🥇 ${p.name} (${teams[p.team].name}) - ${p.goals} goal${p.goals > 1 ? 's' : ''}\n`;
                });
                message += `\n`;
            }
            
            if (stats.topAssisters.length > 0) {
                message += `🎯 *TOP ASSIST${stats.topAssisters.length > 1 ? 'S' : ''}*\n`;
                stats.topAssisters.forEach(p => {
                    message += `🥇 ${p.name} (${teams[p.team].name}) - ${p.assists} assist${p.assists > 1 ? 's' : ''}\n`;
                });
                message += `\n`;
            }
            
            if (stats.topKeepers.length > 0) {
                message += `🧤 *BEST GOALKEEPER${stats.topKeepers.length > 1 ? 'S' : ''}*\n`;
                stats.topKeepers.forEach(k => {
                    message += `🥇 ${k.name} (${teams[k.team].name}) - ${k.saves} save${k.saves > 1 ? 's' : ''}\n`;
                });
                message += `\n`;
            }
            
            if (stats.ownGoalScorers.length > 0) {
                message += `😬 *OWN GOAL${stats.ownGoalScorers.length > 1 ? 'S' : ''}*\n`;
                stats.ownGoalScorers.forEach(p => {
                    message += `• ${p.name} (${teams[p.team].name}) - ${p.ownGoals}\n`;
                });
                message += `\n`;
            }
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            // Team Awards
            message += `🏆 *TEAM AWARDS*\n\n`;
            
            message += `🔥 *BEST ATTACK - MOST GOALS SCORED*\n`;
            stats.bestAttack.forEach(t => {
                message += `${teams[t.key].name} - ${t.gf} goals\n`;
            });
            message += `\n`;
            
            message += `🛡️ *BEST DEFENSE - LEAST GOALS CONCEDED*\n`;
            stats.bestDefense.forEach(t => {
                message += `${teams[t.key].name} - ${t.ga} goals conceded\n`;
            });
            message += `\n`;
            
            message += `🧤 *MOST CLEAN SHEETS*\n`;
            stats.mostCleanSheets.forEach(t => {
                message += `${teams[t.key].name} - ${t.cs} clean sheets\n`;
            });
            message += `\n`;
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            message += `🔗 *View Full Tournament*\n`;
            message += `${shareLink}\n\n`;
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            message += `Thanks for participating! 🎉`;

            summaryContent.textContent = message;
        }

        function copySummaryMessage() {
            const content = document.getElementById('summaryMessageContent').textContent;
            
            navigator.clipboard.writeText(content).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '✅ Copied!';
                btn.style.background = '#128C7E';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#25D366';
                }, 2000);
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = content;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '✅ Copied!';
                btn.style.background = '#128C7E';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#25D366';
                }, 2000);
            });
        }

        function generateWhatsAppMessage() {
            // Only show WhatsApp message for admins
            const whatsappBox = document.getElementById('whatsappMessageBox');
            if (!whatsappBox) return; // Element doesn't exist yet
            
            if (!isAdmin) {
                whatsappBox.classList.add('hidden');
                return;
            }
            
            // Show the WhatsApp message box
            whatsappBox.classList.remove('hidden');
            whatsappBox.style.display = 'block';
            
            let currentUrl = window.location.href;
            
            // Handle special cases for the URL
            if (currentUrl.includes('about:srcdoc') || currentUrl.includes('blob:') || currentUrl === 'about:blank') {
                currentUrl = 'https://claude.ai - (Open this artifact and copy the URL from your browser)';
            }
            
            let message = `🏆 *FOOTBALL TOURNAMENT* 🏆\n\n`;
            
            message += `📅 *Date:* ${tournamentDate}\n\n`;
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            message += `👥 *TEAMS & PLAYERS*\n\n`;
            
            message += `🔴 *RED TEAM*\n`;
            teams.red.players.forEach((p, i) => {
                message += `   ${i + 1}. ${p}\n`;
            });
            message += `\n`;
            
            message += `⚫ *BLACK TEAM*\n`;
            teams.black.players.forEach((p, i) => {
                message += `   ${i + 1}. ${p}\n`;
            });
            message += `\n`;
            
            message += `⚪ *WHITE TEAM*\n`;
            teams.white.players.forEach((p, i) => {
                message += `   ${i + 1}. ${p}\n`;
            });
            message += `\n`;
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            message += `📋 *MATCH SCHEDULE*\n\n`;
            
            const roundRobinMatches = matches.filter(m => m.round !== 'final');
            for (let round = 1; round <= 3; round++) {
                message += `*Round ${round}*\n`;
                const roundMatches = roundRobinMatches.filter(m => m.round === round);
                roundMatches.forEach((m, idx) => {
                    const matchNum = (round - 1) * 3 + idx + 1;
                    message += `   Match ${matchNum}: ${teams[m.team1].name} vs ${teams[m.team2].name}\n`;
                });
                message += `\n`;
            }
            
            message += `*FINAL*\n`;
            message += `   Match 10: P1 vs P2\n`;
            message += `   (Top 2 teams qualify)\n\n`;
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            message += `⚽ *TOURNAMENT FORMAT*\n`;
            message += `• 3 Rounds of Round-Robin (9 matches)\n`;
            message += `• Each match: 10 minutes\n`;
            message += `• First to 3 goals wins (regular matches)\n`;
            message += `• Top 2 teams advance to Final\n`;
            message += `• Points: Win=3, Draw=1, Loss=0\n\n`;
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            message += `📺 *WATCH LIVE*\n`;
            message += `${currentUrl}\n\n`;
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            message += `Let's go! 🎉⚽🔥`;
            
            document.getElementById('messageContent').textContent = message;
        }

        function copyWhatsAppMessage() {
            const messageContent = document.getElementById('messageContent').textContent;
            const btn = document.getElementById('copyMessageBtn');
            const originalText = btn.textContent;
            
            navigator.clipboard.writeText(messageContent).then(() => {
                btn.textContent = '✅ Copied!';
                btn.style.background = '#128C7E';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#25D366';
                }, 2000);
            }).catch(err => {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = messageContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                btn.textContent = '✅ Copied!';
                btn.style.background = '#128C7E';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#25D366';
                }, 2000);
            });
        }

        function generateTournamentSummary() {
            let message = `🏆 *TOURNAMENT RESULTS* 🏆\n\n`;
            
            message += `📅 *Date:* ${tournamentDate}\n\n`;
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            const final = matches.find(m => m.round === 'final');
            const winner = final.score1 > final.score2 ? final.team1 : final.score2 > final.score1 ? final.team2 : null;
            const runnerUp = final.score1 > final.score2 ? final.team2 : final.score2 > final.score1 ? final.team1 : null;
            
            if (winner) {
                message += `👑 *CHAMPION*\n`;
                message += `${teams[winner].name.toUpperCase()} TEAM 🥇\n\n`;
                
                message += `🥈 *RUNNER-UP*\n`;
                message += `${teams[runnerUp].name} Team\n\n`;
            }
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            message += `📊 *FINAL STANDINGS*\n\n`;
            const sorted = Object.entries(standings)
                .map(([key, val]) => ({ key, ...val, gd: val.gf - val.ga, cs: val.cleanSheets || 0 }))
                .sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.gd !== a.gd) return b.gd - a.gd;
                    if (b.gf !== a.gf) return b.gf - a.gf;
                    return b.cs - a.cs;
                });
            
            sorted.forEach((team, idx) => {
                const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : '🥉';
                message += `${medal} *${teams[team.key].name}*\n`;
                message += `   Pts: ${team.points} | P: ${team.played} | W: ${team.won} | D: ${team.drawn} | L: ${team.lost}\n`;
                message += `   GF: ${team.gf} | GA: ${team.ga} | GD: ${team.gd >= 0 ? '+' : ''}${team.gd} | CS: ${team.cs}\n\n`;
            });
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            message += `🏅 *INDIVIDUAL AWARDS*\n\n`;
            
            const topScorersArr = Object.values(playerStats)
                .filter(p => p.goals > 0)
                .sort((a, b) => b.goals - a.goals);
            
            if (topScorersArr.length > 0) {
                const topGoals = topScorersArr[0].goals;
                const topScorers = topScorersArr.filter(p => p.goals === topGoals);
                
                message += `⚽ *TOP SCORER${topScorers.length > 1 ? 'S' : ''}*\n`;
                topScorers.forEach(p => {
                    message += `🥇 ${p.name} (${teams[p.team].name}) - ${p.goals} goal${p.goals > 1 ? 's' : ''}\n`;
                });
                message += `\n`;
            }
            
            const topAssistsArr = Object.values(playerStats)
                .filter(p => p.assists > 0)
                .sort((a, b) => b.assists - a.assists);
            
            if (topAssistsArr.length > 0) {
                const topAssistCount = topAssistsArr[0].assists;
                const topAssisters = topAssistsArr.filter(p => p.assists === topAssistCount);
                
                message += `🎯 *TOP ASSIST${topAssisters.length > 1 ? 'S' : ''}*\n`;
                topAssisters.forEach(p => {
                    message += `🥇 ${p.name} (${teams[p.team].name}) - ${p.assists} assist${p.assists > 1 ? 's' : ''}\n`;
                });
                message += `\n`;
            }
            
            const topKeeperArr = Object.values(keeperStats)
                .filter(k => k.saves > 0)
                .sort((a, b) => b.saves - a.saves);
            
            if (topKeeperArr.length > 0) {
                const topSaves = topKeeperArr[0].saves;
                const topKeepers = topKeeperArr.filter(k => k.saves === topSaves);
                
                message += `🧤 *BEST GOALKEEPER${topKeepers.length > 1 ? 'S' : ''}*\n`;
                topKeepers.forEach(k => {
                    message += `🥇 ${k.name} (${teams[k.team].name}) - ${k.saves} save${k.saves > 1 ? 's' : ''}\n`;
                });
                message += `\n`;
            }
            
            const ownGoalsArr = Object.values(playerStats)
                .filter(p => p.ownGoals && p.ownGoals > 0)
                .sort((a, b) => b.ownGoals - a.ownGoals);
            
            if (ownGoalsArr.length > 0) {
                const topOwnGoals = ownGoalsArr[0].ownGoals;
                const topOwnGoalScorers = ownGoalsArr.filter(p => p.ownGoals === topOwnGoals);
                
                message += `😬 *OWN GOAL${topOwnGoalScorers.length > 1 ? 'S' : ''}*\n`;
                topOwnGoalScorers.forEach(p => {
                    message += `• ${p.name} (${teams[p.team].name}) - ${p.ownGoals}\n`;
                });
                message += `\n`;
            }
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            message += `🏆 *TEAM AWARDS*\n\n`;
            
            const teamMostGoals = sorted[0];
            message += `🔥 *BEST ATTACK - MOST GOALS SCORED*\n`;
            message += `${teams[teamMostGoals.key].name} - ${teamMostGoals.gf} goals\n\n`;
            
            const teamBestDefense = [...sorted].sort((a, b) => a.ga - b.ga)[0];
            message += `🛡️ *BEST DEFENSE - LEAST GOALS CONCEDED*\n`;
            message += `${teams[teamBestDefense.key].name} - ${teamBestDefense.ga} goals conceded\n\n`;
            
            const teamMostCleanSheets = [...sorted].sort((a, b) => b.cs - a.cs)[0];
            message += `🧤 *MOST CLEAN SHEETS*\n`;
            message += `${teams[teamMostCleanSheets.key].name} - ${teamMostCleanSheets.cs} clean sheets\n\n`;
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            
            message += `📋 *ALL MATCH RESULTS*\n\n`;
            matches.forEach((m, idx) => {
                if (m.status === 'completed') {
                    const isFinal = m.round === 'final';
                    const matchLabel = isFinal ? '🏆 FINAL' : `Round ${m.round} - Match ${idx + 1}`;
                    message += `${matchLabel}\n`;
                    message += `${teams[m.team1].name} ${m.score1} - ${m.score2} ${teams[m.team2].name}\n`;
                    
                    if (m.goals && m.goals.length > 0) {
                        const goalScorers = m.goals.filter(g => g.type === 'goal' && !g.ownGoal);
                        if (goalScorers.length > 0) {
                            message += `⚽ Goals: `;
                            goalScorers.forEach((g, i) => {
                                message += `${g.scorer}`;
                                if (g.assist) message += ` (${g.assist})`;
                                if (i < goalScorers.length - 1) message += ', ';
                            });
                            message += `\n`;
                        }
                        
                        const ownGoalScorers = m.goals.filter(g => g.type === 'goal' && g.ownGoal);
                        if (ownGoalScorers.length > 0) {
                            message += `😬 Own Goals: `;
                            ownGoalScorers.forEach((g, i) => {
                                message += `${g.scorer}`;
                                if (i < ownGoalScorers.length - 1) message += ', ';
                            });
                            message += `\n`;
                        }
                        
                        const saves = m.goals.filter(g => g.type === 'save');
                        if (saves.length > 0) {
                            message += `🧤 Saves: `;
                            const saveCounts = {};
                            saves.forEach(s => {
                                saveCounts[s.scorer] = (saveCounts[s.scorer] || 0) + 1;
                            });
                            const saveEntries = Object.entries(saveCounts);
                            saveEntries.forEach(([keeper, count], i) => {
                                message += `${keeper} (${count})`;
                                if (i < saveEntries.length - 1) message += ', ';
                            });
                            message += `\n`;
                        }
                    }
                    message += `\n`;
                }
            });
            
            message += `━━━━━━━━━━━━━━━━━\n\n`;
            message += `Thanks for participating! 🎉⚽\n`;
            message += `See you next time! 👋`;
            
            const summaryElement = document.getElementById('summaryMessageContent');
            if (summaryElement) {
                summaryElement.textContent = message;
            }
        }

        function copySummaryMessage() {
            const messageContent = document.getElementById('summaryMessageContent').textContent;
            
            navigator.clipboard.writeText(messageContent).then(() => {
                const btns = document.querySelectorAll('.copy-btn');
                const btn = btns[btns.length - 1];
                const originalText = btn.textContent;
                btn.textContent = '✅ Copied!';
                btn.style.background = '#128C7E';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#25D366';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy. Please select and copy manually.');
            });
        }

        function updateLeaderboard() {
            const topScorersArr = Object.values(playerStats)
                .sort((a, b) => b.goals - a.goals);

            document.getElementById('topScorers').innerHTML = topScorersArr.filter(p => p.goals > 0).length > 0 
                ? topScorersArr.filter(p => p.goals > 0).map((p, i) => `
                    <div style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between;">
                        <span style="color: ${teams[p.team].color}; font-weight: bold;">${i + 1}. ${p.name}</span>
                        <span style="font-weight: bold;">${p.goals}</span>
                    </div>
                `).join('')
                : '<div style="padding: 10px; color: #999;">No goals yet</div>';

            const topAssistsArr = Object.values(playerStats)
                .sort((a, b) => b.assists - a.assists);

            document.getElementById('topAssists').innerHTML = topAssistsArr.filter(p => p.assists > 0).length > 0
                ? topAssistsArr.filter(p => p.assists > 0).map((p, i) => `
                    <div style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between;">
                        <span style="color: ${teams[p.team].color}; font-weight: bold;">${i + 1}. ${p.name}</span>
                        <span style="font-weight: bold;">${p.assists}</span>
                    </div>
                `).join('')
                : '<div style="padding: 10px; color: #999;">No assists yet</div>';

            const ownGoalsArr = Object.values(playerStats)
                .filter(p => p.ownGoals > 0)
                .sort((a, b) => b.ownGoals - a.ownGoals);

            document.getElementById('ownGoals').innerHTML = ownGoalsArr.length > 0
                ? ownGoalsArr.map((p, i) => `
                    <div style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between;">
                        <span style="color: ${teams[p.team].color}; font-weight: bold;">${i + 1}. ${p.name}</span>
                        <span style="font-weight: bold;">${p.ownGoals}</span>
                    </div>
                `).join('')
                : '<div style="padding: 10px; color: #999;">No own goals</div>';

            const topKeeperArr = Object.values(keeperStats)
                .sort((a, b) => b.saves - a.saves);

            document.getElementById('topKeeper').innerHTML = topKeeperArr.filter(k => k.saves > 0).length > 0
                ? topKeeperArr.filter(k => k.saves > 0).map((k, i) => `
                    <div style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between;">
                        <span style="color: ${teams[k.team].color}; font-weight: bold;">${i + 1}. ${k.name}</span>
                        <span style="font-weight: bold;">${k.saves}</span>
                    </div>
                `).join('')
                : '<div style="padding: 10px; color: #999;">No saves yet</div>';

            const teamCleanSheetsArr = Object.entries(standings)
                .map(([key, val]) => ({ key, cleanSheets: val.cleanSheets || 0 }))
                .sort((a, b) => b.cleanSheets - a.cleanSheets);

            document.getElementById('mostCleanSheets').innerHTML = teamCleanSheetsArr.map((t, i) => `
                <div style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between;">
                    <span style="color: ${teams[t.key].color}; font-weight: bold;">${i + 1}. ${teams[t.key].name}</span>
                    <span style="font-weight: bold;">${t.cleanSheets}</span>
                </div>
            `).join('');

            const teamMostGoalsArr = Object.entries(standings)
                .map(([key, val]) => ({ key, gf: val.gf }))
                .sort((a, b) => b.gf - a.gf);

            document.getElementById('mostGoals').innerHTML = teamMostGoalsArr.map((t, i) => `
                <div style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between;">
                    <span style="color: ${teams[t.key].color}; font-weight: bold;">${i + 1}. ${teams[t.key].name}</span>
                    <span style="font-weight: bold;">${t.gf}</span>
                </div>
            `).join('');

            const teamMostConcededArr = Object.entries(standings)
                .map(([key, val]) => ({ key, ga: val.ga }))
                .sort((a, b) => b.ga - a.ga);

            document.getElementById('mostConceded').innerHTML = teamMostConcededArr.map((t, i) => `
                <div style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between;">
                    <span style="color: ${teams[t.key].color}; font-weight: bold;">${i + 1}. ${teams[t.key].name}</span>
                    <span style="font-weight: bold;">${t.ga}</span>
                </div>
            `).join('');

            const teamBestGDArr = Object.entries(standings)
                .map(([key, val]) => ({ key, gd: val.gf - val.ga }))
                .sort((a, b) => b.gd - a.gd);

            document.getElementById('bestGD').innerHTML = teamBestGDArr.map((t, i) => `
                <div style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between;">
                    <span style="color: ${teams[t.key].color}; font-weight: bold;">${i + 1}. ${teams[t.key].name}</span>
                    <span style="font-weight: bold;">${t.gd >= 0 ? '+' : ''}${t.gd}</span>
                </div>
            `).join('');
        }

        setInterval(() => {
            const final = matches.find(m => m.round === 'final' && m.status === 'completed');
            if (final && !document.getElementById('winnerAnnouncement')) {
                const winner = final.score1 > final.score2 ? final.team1 : 
                              final.score2 > final.score1 ? final.team2 : null;
                
                const winnerSection = document.getElementById('winnerSection');
                if (winner && winnerSection) {
                    winnerSection.innerHTML = `
                        <div class="winner-announcement" id="winnerAnnouncement">
                            <h2>🏆 TOURNAMENT WINNER 🏆</h2>
                            <h1 style="color: ${teams[winner].color}; font-size: 3em; margin: 20px 0;">
                                ${teams[winner].name} TEAM
                            </h1>
                            <p style="font-size: 1.5em;">Congratulations!</p>
                        </div>
                    `;
                    
                    generateTournamentSummary();
                    const tournamentSummarySection = document.getElementById('tournamentSummarySection');
                    if (tournamentSummarySection) {
                        tournamentSummarySection.classList.remove('hidden');
                    }
                }
            }
        }, 1000);
    </script>
</body>
</html>